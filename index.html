<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Messenger Supabase</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f0f2f5;}
header{background:#1e1e2f;color:white;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
header h1{margin:0;font-size:1.5em;}
nav ul{list-style:none;display:flex;gap:15px;margin:0;padding:0;align-items:center;}
nav ul li{position:relative;overflow-x:auto;}
nav ul li a{color:white;text-decoration:none;cursor:pointer;padding:5px 10px;display:block;}
nav ul li ul{display:none;position:absolute;top:30px;left:0;background:#333;padding:10px;border-radius:5px;max-height:200px;overflow-y:auto;white-space:nowrap;}
nav ul li:hover ul{display:block;}
nav ul li ul li a{padding:5px 10px;white-space:nowrap;}
.group-list{margin:20px 0;}
.group{background:white;padding:10px;margin-bottom:5px;border-radius:5px;display:flex;justify-content:space-between;align-items:center;}
.chat-message{background:white;padding:10px;margin-bottom:10px;border-radius:5px;position:relative;word-break:break-word;}
.chat-message .actions{position:absolute;top:0;right:0;display:flex;gap:5px;}
#chatMessages,#privateMessages{max-height:400px;overflow-y:auto;}
input[type=text],button{padding:8px;border-radius:5px;border:1px solid #ccc;}
button{background:#1e1e2f;color:white;cursor:pointer;margin:2px;}
.announcement-bar-container{display:flex;gap:10px;margin:10px 20px;}
.announcement-bar{flex:1;background:#ffcc00;color:#000;padding:10px;overflow:hidden;white-space:nowrap;border-radius:5px;}
.announcement-bar:nth-child(2){background:#00ccff;color:#000;}
.announcement-text{display:inline-block;padding-left:100%;animation:marquee 15s linear infinite;}
@keyframes marquee{0%{transform:translateX(0);}100%{transform:translateX(-100%);}}
#privateChat{display:none;padding:20px;background:#f9f9f9;margin:20px;border-radius:5px;}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>

<header>
<h1>Mini Messenger</h1>
<nav>
<ul>
<li><a>Navigation</a>
<ul>
<li><a onclick="showSection('groups')">Groupes</a></li>
<li><a onclick="showSection('chat')">Chat</a></li>
</ul></li>
<li style="max-width:200px;"><a>Liens</a>
<ul id="externalLinks"></ul></li>
<li><a>Fuseau Horaire</a>
<ul id="timeZones"></ul></li>
<li id="currentTime" style="margin-left:10px;font-weight:bold;"></li>
</ul>
</nav>
</header>

<div class="announcement-bar-container">
<div class="announcement-bar"><span class="announcement-text" id="announcementText1"></span></div>
<div class="announcement-bar"><span class="announcement-text" id="announcementText2"></span></div>
</div>

<section id="groups" style="padding:20px;">
<h2>Mes Groupes <input type="text" id="searchGroup" placeholder="Rechercher" onkeyup="searchGroups()"></h2>
<div class="group-list" id="groupList"></div>
<input type="text" id="newGroup" placeholder="Nom du groupe"><button onclick="createGroup()">Créer</button>
</section>

<section id="chat" style="display:none;padding:20px;">
<h2 id="currentGroupTitle">Chat</h2>
<div id="chatMessages"></div>
<input type="text" id="chatInput" placeholder="Écrire un message...">
<input type="file" id="mediaInput" style="display:none;" onchange="sendMedia(event)">
<button onclick="sendMessage()">Envoyer</button>
<button onclick="addMedia()">📎</button>
</section>

<section id="privateChat">
<h2 id="privateTitle">Conversation privée</h2>
<div id="privateMessages"></div>
<input type="text" id="privateInput" placeholder="Écrire un message...">
<input type="file" id="privateMedia" style="display:none;" onchange="sendPrivateMedia(event)">
<button onclick="sendPrivateMessage()">Envoyer</button>
<button onclick="addPrivateMedia()">📎</button>
</section>

<section id="adminPanel" style="display:none;padding:10px;background:#eee;margin:20px;border-radius:5px;">
<h3>Admin</h3>
<input type="text" id="targetUserId" placeholder="ID utilisateur à bloquer/débloquer">
<button onclick="blockUser()">Bloquer</button>
<button onclick="unblockUser()">Débloquer</button>
<div id="blockedList"></div>
<hr>
<input type="text" id="announcementInput" placeholder="Texte de l’annonce">
<button onclick="setAnnouncement()">Publier</button>
<button onclick="clearAnnouncement()">Supprimer</button>
<hr>
<input type="text" id="linkInput" placeholder="Lien externe">
<button onclick="addExternalLink()">Ajouter</button>
</section>

<div style="margin:20px;">
<input type="text" id="adminCodeInput" placeholder="Code admin">
<button onclick="checkAdmin()">Valider</button>
</div>

<script>
const supabaseUrl = 'https://chgyzvowfsblodxbagfa.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoZ3l6dm93ZnNibG9keGJhZ2ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjA2MjQsImV4cCI6MjA3MzMzNjYyNH0.JEg_WFTJlB3gNBI8-oaP35N68tu9p6TGl6vM3sYPL4Y';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

let userId=localStorage.getItem('userId')||crypto.randomUUID(); localStorage.setItem('userId',userId);
let isAdmin=false,blockedUsers=[],groups=[],currentGroup=null,privateUser=null,externalLinks=[],announcement1='',announcement2='';

// Fuseaux horaires
const zones=["Europe/Paris","America/New_York","Asia/Tokyo","Africa/Douala"];
function updateTime(zone){ const time=new Date().toLocaleString('fr-FR',{timeZone:zone}); document.getElementById('currentTime').textContent=time;}
zones.forEach(zone=>{ const li=document.createElement('li'); li.innerHTML=`<a onclick="updateTime('${zone}')">${zone}</a>`; document.getElementById('timeZones').appendChild(li); });

// Admin
const adminCode='233233';
function checkAdmin(){ if(document.getElementById('adminCodeInput').value===adminCode){isAdmin=true; document.getElementById('adminPanel').style.display='block'; renderGroups();} else alert("Code incorrect");}

// Annonces
function setAnnouncement(){ if(!isAdmin) return; announcement1=document.getElementById('announcementInput').value; announcement2=document.getElementById('announcementInput').value; renderAnnouncements();}
function clearAnnouncement(){ announcement1='';announcement2=''; renderAnnouncements();}
function renderAnnouncements(){ document.getElementById('announcementText1').textContent=announcement1; document.getElementById('announcementText2').textContent=announcement2;}

// Bloquer
function blockUser(){ const t=document.getElementById('targetUserId').value.trim(); if(t&&!blockedUsers.includes(t)) blockedUsers.push(t); updateBlockedList(); }
function unblockUser(){ const t=document.getElementById('targetUserId').value.trim(); blockedUsers=blockedUsers.filter(x=>x!==t); updateBlockedList(); }
function updateBlockedList(){ document.getElementById('blockedList').textContent="Bloqués: "+(blockedUsers.length?blockedUsers.join(', '):"Aucun");}

// Groupes
async function createGroup(){ 
  const name=document.getElementById('newGroup').value.trim(); if(!name) return;
  const {data,error}=await supabase.from('groupes').insert([{name,creator:userId,members:[userId]}]);
  if(!error) renderGroups();
}
async function renderGroups(){ 
  const {data,error}=await supabase.from('groupes').select('*');
  if(data){ 
    const container=document.getElementById('groupList'); container.innerHTML='';
    data.forEach(g=>{ 
      const div=document.createElement('div'); 
      div.className='group'; 
      div.innerHTML=`<span onclick="openGroup('${g.id}')">${g.name}</span> <span>${g.members.length} abonnés</span>`; 
      container.appendChild(div);
    });
  }
}
function searchGroups(){ const val=document.getElementById('searchGroup').value.toLowerCase(); Array.from(document.getElementById('groupList').children).forEach(div=>div.style.display=div.innerText.toLowerCase().includes(val)?'flex':'none');}
function openGroup(id){ currentGroup=id; showSection('chat'); document.getElementById('currentGroupTitle').textContent='Chat: '+id; }

// Sections
function showSection(section){
  document.getElementById('groups').style.display=section==='groups'?'block':'none';
  document.getElementById('chat').style.display=section==='chat'?'block':'none';
  document.getElementById('privateChat').style.display=section==='private'?'block':'none';
}

// Liens externes
function addExternalLink(){ const url=document.getElementById('linkInput').value.trim(); if(!url) return; externalLinks.push(url); renderExternalLinks();}
function renderExternalLinks(){ const ul=document.getElementById('externalLinks'); ul.innerHTML=''; externalLinks.forEach((l,i)=>{ const li=document.createElement('li'); li.innerHTML=`<a href="${l}" target="_blank">${l} <button onclick="removeLink(${i})">✖</button></a>`; ul.appendChild(li);});}
function removeLink(i){ externalLinks.splice(i,1); renderExternalLinks();}

// Chat groupe
async function sendMessage(){ 
  if(!currentGroup) return; 
  const text=document.getElementById('chatInput').value.trim(); if(!text) return;
  await supabase.from('messages_groupes').insert([{group_id:currentGroup,user:userId,text,media:null,timestamp:new Date().toISOString()}]);
  document.getElementById('chatInput').value=''; renderGroupMessages();
}
function addMedia(){ document.getElementById('mediaInput').click(); }
async function sendMedia(event){ const file=event.target.files[0]; if(!file) return; 
const reader=new FileReader();
reader.onload=async e=>{
  await supabase.from('messages_groupes').insert([{
    group_id: currentGroup,
    user: userId,
    text: '',
    media: e.target.result,
    media_type: file.type,
    timestamp: new Date().toISOString()
  }]);
  renderGroupMessages();
};
reader.readAsDataURL(file);
}

async function renderGroupMessages(){
  if(!currentGroup) return;
  const {data,error}=await supabase.from('messages_groupes').select('*').eq('group_id',currentGroup).order('timestamp',{ascending:true});
  const container=document.getElementById('chatMessages');
  container.innerHTML='';
  if(data){
    data.forEach(msg=>{
      const div=document.createElement('div');
      div.className='chat-message';
      let mediaHtml='';
      if(msg.media){
        if(msg.media_type.startsWith('image')) mediaHtml=`<img src="${msg.media}">`;
        else if(msg.media_type.startsWith('video')) mediaHtml=`<video src="${msg.media}" controls></video>`;
        else if(msg.media_type.startsWith('audio')) mediaHtml=`<audio src="${msg.media}" controls></audio>`;
        else mediaHtml=`<a href="${msg.media}" target="_blank">Fichier</a>`;
      }
      div.innerHTML=`<strong>${msg.user}</strong> [${new Date(msg.timestamp).toLocaleTimeString()}]: ${msg.text||''} ${mediaHtml}`;
      if(msg.user===userId || isAdmin){
        const actions=document.createElement('div');
        actions.className='actions';
        const editBtn=document.createElement('button');
        editBtn.textContent='✏️';
        editBtn.onclick=async ()=>{ const newText=prompt('Modifier message:',msg.text); if(newText!==null){ await supabase.from('messages_groupes').update({text:newText}).eq('id',msg.id); renderGroupMessages(); }};
        const delBtn=document.createElement('button');
        delBtn.textContent='🗑️';
        delBtn.onclick=async ()=>{ await supabase.from('messages_groupes').delete().eq('id',msg.id); renderGroupMessages(); };
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        div.appendChild(actions);
      }
      container.appendChild(div);
    });
    container.scrollTop=container.scrollHeight;
  }
}

// Messages privés
function openPrivateChat(otherUser){
  privateUser=otherUser;
  showSection('private');
  document.getElementById('privateTitle').textContent='Conversation avec '+otherUser;
  renderPrivateMessages();
}

async function sendPrivateMessage(){
  if(!privateUser) return;
  const text=document.getElementById('privateInput').value.trim(); if(!text) return;
  await supabase.from('messages_prives').insert([{user1:userId,user2:privateUser,text,media:null,timestamp:new Date().toISOString()}]);
  document.getElementById('privateInput').value='';
  renderPrivateMessages();
}

function addPrivateMedia(){ document.getElementById('privateMedia').click(); }
async function sendPrivateMedia(event){ const file=event.target.files[0]; if(!file || !privateUser) return;
const reader=new FileReader();
reader.onload=async e=>{
  await supabase.from('messages_prives').insert([{
    user1:userId,
    user2:privateUser,
    text:'',
    media:e.target.result,
    media_type:file.type,
    timestamp:new Date().toISOString()
  }]);
  renderPrivateMessages();
};
reader.readAsDataURL(file);
}

async function renderPrivateMessages(){
  if(!privateUser) return;
  const {data,error}=await supabase.from('messages_prives').select('*')
    .or(`user1.eq.${userId},user2.eq.${userId}`)
    .order('timestamp',{ascending:true});
  const container=document.getElementById('privateMessages');
  container.innerHTML='';
  if(data){
    data.filter(m=>m.user1===privateUser || m.user2===privateUser).forEach(msg=>{
      const div=document.createElement('div');
      div.className='chat-message';
      let mediaHtml='';
      if(msg.media){
        if(msg.media_type.startsWith('image')) mediaHtml=`<img src="${msg.media}">`;
        else if(msg.media_type.startsWith('video')) mediaHtml=`<video src="${msg.media}" controls></video>`;
        else if(msg.media_type.startsWith('audio')) mediaHtml=`<audio src="${msg.media}" controls></audio>`;
        else mediaHtml=`<a href="${msg.media}" target="_blank">Fichier</a>`;
      }
      div.innerHTML=`<strong>${msg.user1===userId?userId:privateUser}</strong> [${new Date(msg.timestamp).toLocaleTimeString()}]: ${msg.text||''} ${mediaHtml}`;
      if(msg.user1===userId || isAdmin){
        const actions=document.createElement('div');
        actions.className='actions';
        const editBtn=document.createElement('button');
        editBtn.textContent='✏️';
        editBtn.onclick=async ()=>{ const newText=prompt('Modifier message:',msg.text); if(newText!==null){ await supabase.from('messages_prives').update({text:newText}).eq('id',msg.id); renderPrivateMessages(); }};
        const delBtn=document.createElement('button');
        delBtn.textContent='🗑️';
        delBtn.onclick=async ()=>{ await supabase.from('messages_prives').delete().eq('id',msg.id); renderPrivateMessages(); };
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        div.appendChild(actions);
      }
      container.appendChild(div);
    });
    container.scrollTop=container.scrollHeight;
  }
}

// Auto clean messages >24h
async function cleanOldMessages(){
  const limit=new Date(Date.now()-24*60*60*1000).toISOString();
  await supabase.from('messages_groupes').delete().lt('timestamp',limit);
  await supabase.from('messages_prives').delete().lt('timestamp',limit);
}

// Initialisation
renderGroups();
renderAnnouncements();
setInterval(renderGroupMessages,5000);
setInterval(renderPrivateMessages,5000);
setInterval(cleanOldMessages,60*60*1000); // toutes les heures
</script>
</body>
</html>