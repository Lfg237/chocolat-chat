<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Messenger Supabase</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f2f5; }
header { background:#1e1e2f; color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
nav { display:flex; gap:20px; flex-wrap:wrap; }
nav ul { list-style:none; display:flex; gap:20px; margin:0; padding:0; }
nav ul li { position:relative; }
nav ul li a { color:white; text-decoration:none; cursor:pointer; padding:5px 10px; display:block; }
nav ul li ul { display:none; position:absolute; top:30px; left:0; background-color:#333; padding:10px; border-radius:5px; max-height:200px; overflow-y:auto; white-space:nowrap; }
nav ul li:hover ul { display:block; }
footer { background:#1e1e2f; color:white; text-align:center; padding:20px; }
.announcement-bar { background:#ffcc00; color:#000; padding:10px; overflow:hidden; white-space:nowrap; }
.announcement-bar.second { background:#00ccff; }
.announcement-text { display:inline-block; padding-left:100%; animation: marquee 15s linear infinite; }
@keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
.chat-container { padding:20px; }
.chat-message { background:white; padding:10px; margin-bottom:10px; border-radius:5px; position:relative; word-break:break-word; }
.chat-message .actions { position:absolute; top:0; right:0; display:flex; gap:5px; }
.chat-message img, .chat-message video, .chat-message audio, .chat-message iframe { max-width:100%; border-radius:5px; margin-top:5px; }
.chat-input { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
.chat-input input { flex:1; padding:10px; border-radius:5px; border:1px solid #ccc; }
.chat-input button { padding:10px 15px; border:none; border-radius:5px; background:#1e1e2f; color:white; cursor:pointer; }
.group-list { margin-bottom:20px; display:flex; flex-direction:column; gap:5px; }
.group { background:white; padding:10px; border-radius:5px; display:flex; justify-content:space-between; align-items:center; }
.admin-panel { margin:20px; padding:10px; background:#e0e0e0; border-radius:5px; }
.admin-panel input, .admin-panel button { margin:5px 0; }
.like-button { background:#eee; border:none; padding:2px 5px; border-radius:3px; cursor:pointer; }
.like-button.liked { background:#ffcc00; }
.menu-scroll { display:flex; overflow-x:auto; gap:10px; padding:5px 0; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
</head>
<body>

<header>
<div>
<h1>Mini Messenger</h1>
<div id="timeDisplay">Heure locale: --:--:--</div>
</div>
<nav>
<ul>
<li><a>Navigation</a>
<ul>
<li><a onclick="showSection('groups')">Groupes</a></li>
<li><a onclick="showSection('chat')">Chat</a></li>
<li><a onclick="showSection('private')">Priv√©</a></li>
</ul>
</li>
<li><a>Liens</a>
<ul class="menu-scroll" id="externalLinks"></ul>
</li>
</ul>
</nav>
</header>

<div id="announcementBar" class="announcement-bar" style="display:none;"><span id="announcementText" class="announcement-text"></span></div>
<div id="announcementBar2" class="announcement-bar second" style="display:none;"><span id="announcementText2" class="announcement-text"></span></div>

<section id="groups" class="chat-container">
<h2>Mes Groupes <input type="text" id="searchGroup" placeholder="Rechercher un groupe..." onkeyup="searchGroups()"></h2>
<div class="group-list" id="groupList"></div>
<input type="text" id="newGroup" placeholder="Nom du nouveau groupe">
<button onclick="createGroup()">Cr√©er Groupe</button>
</section>

<section id="chat" class="chat-container" style="display:none">
<h2 id="currentGroupTitle">Chat</h2>
<div id="chatMessages"></div>
<div class="chat-input">
<input type="text" id="chatInput" placeholder="√âcrire un message...">
<button onclick="sendMessage()">Envoyer</button>
<button onclick="addMedia()">üìé</button>
<input type="file" id="mediaInput" style="display:none" onchange="sendMedia(event)" accept="image/*,video/*,audio/*,.pdf">
</div>
</section>

<section id="private" class="chat-container" style="display:none">
<h2 id="currentPrivateTitle">Chat Priv√©</h2>
<div id="privateMessages"></div>
<div class="chat-input">
<input type="text" id="privateInput" placeholder="√âcrire un message...">
<button onclick="sendPrivate()">Envoyer</button>
<input type="file" id="privateMediaInput" style="display:none" onchange="sendPrivateMedia(event)" accept="image/*,video/*,audio/*,.pdf">
</div>
</section>

<div class="admin-panel" id="adminPanel" style="display:none">
<h3>Admin</h3>
<input type="text" id="targetUser" placeholder="ID utilisateur √† bloquer/d√©bloquer">
<button onclick="blockUser()">Bloquer</button>
<button onclick="unblockUser()">D√©bloquer</button>
<div id="blockedList"></div>
<hr>
<input type="text" id="announcementInput" placeholder="Annonce 1">
<input type="color" id="announcementColor" value="#ffcc00">
<button onclick="setAnnouncement(1)">Publier</button>
<button onclick="clearAnnouncement(1)">Supprimer</button>
<br>
<input type="text" id="announcementInput2" placeholder="Annonce 2">
<input type="color" id="announcementColor2" value="#00ccff">
<button onclick="setAnnouncement(2)">Publier</button>
<button onclick="clearAnnouncement(2)">Supprimer</button>
<hr>
<h4>G√©rer liens menu droit</h4>
<input type="text" id="linkName" placeholder="Nom du lien">
<input type="text" id="linkURL" placeholder="URL du lien">
<button onclick="addLink()">Ajouter</button>
<div id="linkList" class="menu-scroll"></div>
</div>

<div class="admin-panel">
<input type="text" id="adminCodeInput" placeholder="Code admin">
<button onclick="checkAdmin()">Valider</button>
</div>

<footer>&copy; 2025 Mini Messenger</footer>

<script>
const SUPABASE_URL="https://chgyzvowfsblodxbagfa.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoZ3l6dm93ZnNibG9keGJhZ2ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjA2MjQsImV4cCI6MjA3MzMzNjYyNH0.JEg_WFTJlB3gNBI8-oaP35N68tu9p6TGl6vM3sYPL4Y";
const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let userId = crypto.randomUUID();
let isAdmin = false;
let currentGroup = null;
let currentPrivate = null;
let blocked = [];

// Gestion du temps
function updateTime(){
  const now=new Date();
  document.getElementById('timeDisplay').textContent="Heure locale: "+now.toLocaleTimeString();
}
setInterval(updateTime,1000);
updateTime();

// Navigation sections
function showSection(id){
  document.getElementById('groups').style.display=id==='groups'?'block':'none';
  document.getElementById('chat').style.display=id==='chat'?'block':'none';
  document.getElementById('private').style.display=id==='private'?'block':'none';
}

// Admin
function checkAdmin(){
  const code=document.getElementById('adminCodeInput').value.trim();
  if(code==='233233'){isAdmin=true; document.getElementById('adminPanel').style.display='block'; alert("Admin activ√©");} 
  else alert("Code incorrect");
}

// Donn√©es locales
let groups = [];
let privateMessages = {};
let links = [];
let announcements = [{text:'',color:'#ffcc00'},{text:'',color:'#00ccff'}];

// --- Fonctions groupes ---
async function createGroup(){
  const name=document.getElementById('newGroup').value.trim();
  if(!name) return;
  const { data, error } = await supabase.from('groups').insert([{name}]);
  if(error){alert(error.message); return;}
  document.getElementById('newGroup').value='';
  fetchGroups();
}

async function fetchGroups(){
  const { data, error } = await supabase.from('groups').select('*');
  if(error){alert(error.message); return;}
  groups = data;
  renderGroups();
}

function renderGroups(){
  const container=document.getElementById('groupList');
  container.innerHTML='';
  groups.forEach(g=>{
    const div=document.createElement('div');
    div.className='group';
    div.innerHTML=`<span onclick="openGroup(${g.id})">${g.name}</span> <span>${g.members_count||0} abonn√©s</span>`;
    container.appendChild(div);
  });
}

// --- Open Group Chat ---
async function openGroup(groupId){
  currentGroup=groupId;
  const group = groups.find(g=>g.id===groupId);
  document.getElementById('currentGroupTitle').textContent=group.name;
  showSection('chat');
  fetchMessages(groupId);
}

// --- Messages ---
async function fetchMessages(groupId){
  const { data,error } = await supabase.from('messages').select('*').eq('group_id',groupId).order('timestamp',{ascending:true});
  if(error){alert(error.message); return;}
  const container=document.getElementById('chatMessages');
  container.innerHTML='';
  data.forEach(msg=>{
    const div=document.createElement('div');
    div.className='chat-message';
    let media='';
    if(msg.media_url){
      if(msg.media_type.startsWith('image')) media=`<img src="${msg.media_url}">`;
      else if(msg.media_type.startsWith('video')) media=`<video src="${msg.media_url}" controls></video>`;
      else if(msg.media_type.startsWith('audio')) media=`<audio src="${msg.media_url}" controls></audio>`;
      else media=`<a href="${msg.media_url}" target="_blank">Fichier</
</a>`;
    }
    div.innerHTML = `<strong>${msg.user_id}</strong>: ${msg.text || ''} ${media} <button class="like-button ${msg.liked_by?.includes(userId)?'liked':''}" onclick="likeMessage(${msg.id}, ${groupId})">‚ù§ ${msg.likes||0}</button>`;
    
    // Actions pour l'auteur ou admin
    if(msg.user_id===userId || isAdmin){
      const actions=document.createElement('div');
      actions.className='actions';
      
      const editBtn=document.createElement('button');
      editBtn.textContent='‚úèÔ∏è';
      editBtn.onclick=async ()=>{
        const newText=prompt('Modifier message:',msg.text);
        if(newText!==null){
          await supabase.from('messages').update({text:newText}).eq('id',msg.id);
          fetchMessages(groupId);
        }
      };
      
      const delBtn=document.createElement('button');
      delBtn.textContent='üóëÔ∏è';
      delBtn.onclick=async ()=>{
        await supabase.from('messages').delete().eq('id',msg.id);
        fetchMessages(groupId);
      };
      
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      div.appendChild(actions);
    }
    
    container.appendChild(div);
  });
  container.scrollTop=container.scrollHeight;
}

// --- Envoyer un message ---
async function sendMessage(){
  const input=document.getElementById('chatInput');
  if(!input.value.trim() || !currentGroup) return;
  await supabase.from('messages').insert([{
    group_id: currentGroup,
    user_id: userId,
    text: input.value,
    media_url: null,
    media_type: null,
    likes: 0,
    liked_by: [],
    timestamp: new Date().toISOString()
  }]);
  input.value='';
  fetchMessages(currentGroup);
}

// --- Envoyer m√©dias ---
function addMedia(){ document.getElementById('mediaInput').click(); }
async function sendMedia(event){
  const file=event.target.files[0];
  if(!file || !currentGroup) return;
  const { data, error } = await supabase.storage.from('media').upload(`${Date.now()}_${file.name}`, file);
  if(error){alert(error.message); return;}
  const url = `${SUPABASE_URL}/storage/v1/object/public/media/${data.path}`;
  await supabase.from('messages').insert([{
    group_id: currentGroup,
    user_id: userId,
    text:'',
    media_url:url,
    media_type:file.type,
    likes:0,
    liked_by:[],
    timestamp: new Date().toISOString()
  }]);
  fetchMessages(currentGroup);
}

// --- Like message ---
async function likeMessage(msgId, groupId){
  const { data: msg } = await supabase.from('messages').select('*').eq('id',msgId).single();
  let liked_by = msg.liked_by || [];
  let likes = msg.likes || 0;
  if(!liked_by.includes(userId)){
    liked_by.push(userId); likes++;
  } else {
    liked_by = liked_by.filter(u=>u!==userId); likes--;
  }
  await supabase.from('messages').update({liked_by, likes}).eq('id',msgId);
  fetchMessages(groupId);
}

// --- Barre de recherche ---
function searchGroups(){
  const val=document.getElementById('searchGroup').value.toLowerCase();
  const filtered=groups.filter(g=>g.name.toLowerCase().includes(val));
  const container=document.getElementById('groupList');
  container.innerHTML='';
  filtered.forEach(g=>{
    const div=document.createElement('div');
    div.className='group';
    div.innerHTML=`<span onclick="openGroup(${g.id})">${g.name}</span> <span>${g.members_count||0} abonn√©s</span>`;
    container.appendChild(div);
  });
}

// --- Annonces ---
function renderAnnouncements(){
  const bar1=document.getElementById('announcementBar'); 
  const bar2=document.getElementById('announcementBar2');
  if(announcements[0].text){bar1.style.display='block'; bar1.querySelector('.announcement-text').textContent=announcements[0].text; bar1.style.background=announcements[0].color;} else bar1.style.display='none';
  if(announcements[1].text){bar2.style.display='block'; bar2.querySelector('.announcement-text').textContent=announcements[1].text; bar2.style.background=announcements[1].color;} else bar2.style.display='none';
}
function setAnnouncement(n){
  const text=document.getElementById(`announcementInput${n===2?'2':''}`).value.trim();
  const color=document.getElementById(`announcementColor${n===2?'2':''}`).value;
  announcements[n-1]={text,color};
  renderAnnouncements();
}
function clearAnnouncement(n){ announcements[n-1]={text:'',color:'#fff'}; renderAnnouncements(); }

// --- Bloquer / d√©bloquer utilisateur ---
function blockUser(){ const u=document.getElementById('targetUser').value.trim(); if(!blocked.includes(u)) blocked.push(u); updateBlocked(); }
function unblockUser(){ const u=document.getElementById('targetUser').value.trim(); blocked=blocked.filter(x=>x!==u); updateBlocked(); }
function updateBlocked(){ document.getElementById('blockedList').textContent=blocked.join(', ')||'Aucun'; }

// --- Gestion liens menu droit ---
function addLink(){ const name=document.getElementById('linkName').value.trim(); const url=document.getElementById('linkURL').value.trim(); if(!name||!url) return; links.push({name,url}); renderLinks(); }
function renderLinks(){ const container=document.getElementById('externalLinks'); container.innerHTML=''; links.forEach(l=>{ const a=document.createElement('a'); a.href=l.url; a.target='_blank'; a.textContent=l.name; container.appendChild(a); }); }

// --- Initialisation ---
fetchGroups();
renderAnnouncements();
renderLinks();
</script>

</body>
</html>