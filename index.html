<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mini Secr√©tariat - Multi-Documents Complet</title>
<style>
  body{font-family:Arial,sans-serif;margin:0;padding:0;background:linear-gradient(120deg,#ffecd2,#fcb69f,#a1c4fd,#c2e9fb);background-size:600% 600%;animation:gradientBG 15s ease infinite;overflow-x:hidden;}
  @keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  header,footer{background:#00796b;color:#fff;padding:10px;text-align:center;position:fixed;width:100%;z-index:10;}
  header{top:0} footer{bottom:0}
  .nav-buttons{position:fixed;top:56px;left:50%;transform:translateX(-50%);z-index:20;display:flex;gap:8px;padding:6px;border-radius:10px;background:rgba(255,255,255,0.95);}
  .nav-buttons button{padding:8px 12px;border-radius:6px;border:none;background:#ff7043;color:#fff;font-weight:700;cursor:pointer;}
  .nav-container{display:flex;overflow-x:auto;scroll-behavior:smooth;margin:120px 0 70px 0;padding:12px;}
  .doc-card{min-width:360px;background:#fff;border-radius:12px;padding:18px;margin:0 10px;box-shadow:0 6px 18px rgba(0,0,0,0.12);flex-shrink:0;}
  .photo{width:80px;height:80px;border-radius:10px;border:2px dashed #00796b;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;background:#e8f5f2;}
  .photo img{width:100%;height:100%;object-fit:cover;}
  .field{margin:8px 0;}
  label{font-weight:700;color:#004d40;}
  input,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;margin-top:6px;}
  canvas{border:1px solid #00796b;border-radius:6px;margin-top:6px;touch-action:none;}
  button.action{background:#00796b;color:#fff;padding:10px 16px;border-radius:8px;border:none;cursor:pointer;}
  button.ghost{background:#e0e0e0;color:#333;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;margin-left:8px;}
  #popupOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9998;align-items:center;justify-content:center;padding:12px;}
  #popup{background:#fff;padding:18px;border-radius:10px;width:420px;max-width:100%;box-shadow:0 8px 30px rgba(0,0,0,0.3);white-space:pre-line;}
  #beneficiaryInfo{white-space:pre-line;margin-top:10px;font-weight:700;color:#004d40;}
  .accessTimer{margin-top:8px;color:#d32f2f;font-weight:700;}
  .small{font-size:12px;color:#666;margin-top:4px;}
</style>
</head>
<body>
<header>üñ•Ô∏è Mini Secr√©tariat - Multi-Documents Complet</header>

<div class="nav-buttons">
  <button onclick="scrollPrev()">‚¨ÖÔ∏è</button>
  <button onclick="scrollNext()">‚û°Ô∏è</button>
  <button onclick="showAll()">üìÑ Tous</button>
</div>

<div class="nav-container" id="docNav">
  <!-- CV Enrichi -->
  <div class="doc-card" data-doc="CV">
    <h3>üìÑ CV Pro Enrichi</h3>
    <div class="photo" onclick="choosePhoto('CV')"><img id="profilePhotoCV" src="https://via.placeholder.com/80"></div>
    <input id="photoInputCV" type="file" accept="image/*" style="display:none" onchange="updatePhoto('CV',this)">
    <div class="field"><label>Nom</label><input id="nameCV" value="Jean Dupont"></div>
    <div class="field"><label>Profession</label><input id="professionCV" value="D√©veloppeur Web"></div>
    <div class="field"><label>Email</label><input id="emailCV" value="jean.dupont@email.com"></div>
    <div class="field"><label>Comp√©tences</label><textarea id="skillsCV" rows="3">HTML, CSS, JS, Node.js</textarea></div>
    <div class="field"><label>Formations</label><textarea id="educationCV" rows="3">Licence Informatique</textarea></div>
    <div class="field"><label>Exp√©riences</label><textarea id="experienceCV" rows="3">D√©veloppeur Front-end chez X</textarea></div>
    <div class="field"><label>Signature</label><canvas id="signatureCV" width="300" height="80"></canvas><br>
    <button class="ghost" onclick="clearSignature('CV')">üóë Effacer</button></div>
    <button class="action" onclick="checkAccessAndDownload('CV')">üí≥ T√©l√©charger PDF (Paiement)</button>
    <div class="accessTimer" id="timerCV"></div>
  </div>

  <!-- Carte de visite -->
  <div class="doc-card" data-doc="Card">
    <h3>üí≥ Carte de Visite</h3>
    <div class="photo" onclick="choosePhoto('Card')"><img id="profilePhotoCard" src="https://via.placeholder.com/80"></div>
    <input id="photoInputCard" type="file" accept="image/*" style="display:none" onchange="updatePhoto('Card',this)">
    <div class="field"><label>Nom</label><input id="nameCard" value="Jean Dupont"></div>
    <div class="field"><label>Profession</label><input id="professionCard" value="D√©veloppeur Web"></div>
    <div class="field"><label>T√©l√©phone</label><input id="phoneCard" value="+237 650 000 000"></div>
    <div class="field"><label>Email</label><input id="emailCard" value="jean.dupont@email.com"></div>
    <div class="field"><label>Signature</label><canvas id="signatureCard" width="300" height="50"></canvas><br>
    <button class="ghost" onclick="clearSignature('Card')">üóë Effacer</button></div>
    <button class="action" onclick="checkAccessAndDownload('Card')">üí≥ T√©l√©charger PDF (Paiement)</button>
    <div class="accessTimer" id="timerCard"></div>
  </div>

  <div id="additionalDocs"></div>
</div>

<footer>¬© 2025 Mini Secr√©tariat</footer>

<div id="popupOverlay"><div id="popup"></div></div>

<script>
/* ========== Frontend JS ========== */
const BENEFICIARY = { name: "Loveline Wirnkar", momo: "676353859", om: "640647072" };
let currentDoc = null;

// Navigation
const nav = document.getElementById('docNav');
function scrollNext(){ const w = document.querySelector('.doc-card').offsetWidth + 20; nav.scrollBy({left:w,behavior:'smooth'}); }
function scrollPrev(){ const w = document.querySelector('.doc-card').offsetWidth + 20; nav.scrollBy({left:-w,behavior:'smooth'}); }
function showAll(){ nav.scrollTo({left:0,behavior:'smooth'}); }

// Photos
function choosePhoto(id){ document.getElementById('photoInput'+id).click(); }
function updatePhoto(id,input){ const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => {
  const map = {'CV':'profilePhotoCV','Card':'profilePhotoCard'}; if(map[id]) document.getElementById(map[id]).src = e.target.result; }; r.readAsDataURL(f); }

// Signatures: stabilize touch and prevent scroll during signing
function initSignatures(){
  const ids = ['CV','Card'];
  ids.forEach(id=>{
    const c = document.getElementById('signature'+id);
    if(!c) return;
    const ctx = c.getContext('2d'); ctx.lineWidth = 2; ctx.strokeStyle = '#00796b';
    let drawing = false;
    c.addEventListener('pointerdown', e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
    c.addEventListener('pointermove', e => { if(drawing){ ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); }});
    c.addEventListener('pointerup', e => { drawing = false; });
    c.addEventListener('pointerleave', e => { drawing = false; });
    // block touch scroll while interacting
    c.addEventListener('touchstart', e => { e.preventDefault(); }, {passive:false});
    c.addEventListener('touchmove', e => { e.preventDefault(); }, {passive:false});
  });
}
function clearSignature(id){ const c = document.getElementById('signature'+id); if(!c) return; c.getContext('2d').clearRect(0,0,c.width,c.height); }
window.addEventListener('load', initSignatures);

// Popup helpers
function showPopup(content){ const popup = document.getElementById('popup'); popup.innerHTML = content; document.getElementById('popupOverlay').style.display = 'flex'; }
function hidePopup(){ document.getElementById('popupOverlay').style.display = 'none'; }

// ========== Validation + Secure download flow (frontend) ==========
// Affiche popup et envoie adminCode / momoMessage √† /api/validate
function checkAccessAndDownload(doc){
  currentDoc = doc;
  let content = `<h3>üí≥ Paiement pour ${doc}</h3>`;
  content += `<div id="beneficiaryInfo">B√©n√©ficiaire: ${BENEFICIARY.name}\nMomo: ${BENEFICIARY.momo}\nOM: ${BENEFICIARY.om}</div>`;
  content += `<div style="margin-top:10px;"><label>Code Admin (si disponible):</label><input id="adminCode" placeholder="Code admin" style="width:100%"></div>`;
  content += `<div style="margin-top:10px;"><label>Message Mobile Money :</label><input id="momoMessage" placeholder="Copie ici le message de paiement" style="width:100%"></div>`;
  content += `<div style="margin-top:10px;"><button onclick="submitForValidation()">‚úÖ Envoyer pour validation</button> <button onclick="hidePopup()">‚ùå Annuler</button></div>`;
  showPopup(content);
}

async function submitForValidation(){
  const code = document.getElementById('adminCode').value.trim();
  const msg  = document.getElementById('momoMessage').value.trim();

  try {
    const res = await fetch('/api/validate', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ adminCode: code, momoMessage: msg, doc: currentDoc })
    });

    if(!res.ok){
      const txt = await res.text();
      console.error('validate http error', res.status, txt);
      alert('Erreur serveur lors de la validation');
      return;
    }

    const j = await res.json();
    if(j.ok){
      hidePopup();
      alert(`‚úÖ Paiement valid√© (${j.method}). T√©l√©chargement en cours...`);
      // j.token doit exister (token usage unique TTL)
      if(!j.token){
        console.error('Aucun token re√ßu depuis /api/validate. V√©rifie le backend.');
        alert('Erreur: aucun token re√ßu.');
        return;
      }
      await downloadPDFServer(currentDoc, j.token);
    } else {
      alert('‚ùå Validation refus√©e : ' + (j.reason || 'invalide'));
    }
  } catch (err) {
    console.error('submitForValidation error', err);
    alert('Erreur r√©seau ou serveur. Regarde la console pour plus de d√©tails.');
  }
}

// Appelle /api/get-file avec token pour r√©cup√©rer le PDF (dataURI) et forcer t√©l√©chargement
async function downloadPDFServer(doc, token){
  if(!token){ alert('Aucun token fourni ‚Äî impossible de t√©l√©charger.'); return; }

  try {
    const res = await fetch('/api/get-file', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ token, docName: doc })
    });

    if(!res.ok){
      const txt = await res.text();
      console.error('get-file http error', res.status, txt);
      alert('Erreur lors du t√©l√©chargement (serveur).');
      return;
    }

    const j = await res.json();
    if(j.ok && j.pdf){
      // j.pdf is data URI: "data:application/pdf;base64,...."
      const link = document.createElement('a');
      link.href = j.pdf;
      link.download = `${doc}.pdf`;
      document.body.appendChild(link);
      link.click();
      link.remove();
    } else {
      alert('Erreur t√©l√©chargement : ' + (j.reason || 'PDF non disponible'));
      console.error('get-file response', j);
    }
  } catch (err) {
    console.error('downloadPDFServer error', err);
    alert('Erreur r√©seau ou serveur pendant le t√©l√©chargement.');
  }
}
</script>
</body>
</html>