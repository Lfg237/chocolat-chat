<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CV / Lettre / Plan</title>
<style>
body {font-family: 'Segoe UI', Arial, sans-serif; background: #e0f7fa; margin: 0; padding: 10px;}
h1 {text-align: center; color: #00695c; font-size: 28px; margin-bottom: 20px;}
section {padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.15);}
#cvDoc {background: #fff3e0; border-left: 8px solid #ff6f00;}
#lettreDoc {background: #e8f5e9; border-left: 8px solid #43a047;}
#planDoc {background: #e3f2fd; border-left: 8px solid #1e88e5;}
h2 {color: #424242; font-size: 22px; margin-bottom: 10px;}
input, textarea {width: 100%; padding: 10px; margin: 6px 0; border: 2px solid #1e88e5; border-radius: 8px; font-size: 14px;}
button.primary {background: linear-gradient(45deg,#00c853,#b2ff59); color: #fff; font-weight: bold; border: none; padding: 10px; border-radius: 8px; margin-top: 5px; cursor:pointer;}
.cv-photo-preview {width: 180px; height: 180px; border: 3px dashed #ff6f00; border-radius: 50%; margin: 0 auto 10px auto; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: #ff6f00; font-size: 14px; font-weight: bold;}
canvas.signature-canvas {border: 2px solid #43a047; border-radius: 5px; width: 100%; height: 120px; touch-action: none;}
#popupOverlay {display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:9999;}
#popup {border:3px solid #1e88e5; background:#fffde7; padding:15px; border-radius:10px; width:100%; max-width:400px;}
.flex-row {display:flex; justify-content:space-between; align-items:center; margin-top:5px;}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
<h1>üìÑ Mes Documents</h1>

<!-- CV -->
<section id="cvDoc">
<h2>CV</h2>
<div class="cv-photo-preview" id="cvPhotoPreview">Importer photo</div>
<input type="file" id="cvPhotoInput" accept="image/*">
<h3 id="cvName" style="text-align:center;font-weight:bold;font-size:20px;">Nom Complet</h3>
<p id="cvProfession" style="text-align:center;font-size:14px;">Profession</p>
<input id="cvPrenom" placeholder="Pr√©nom">
<input id="cvNom" placeholder="Nom">
<input id="cvAge" placeholder="√Çge">
<input id="cvVille" placeholder="Ville">
<input id="cvQuartier" placeholder="Quartier">
<input id="cvSituation" placeholder="Situation matrimoniale">
<input id="cvEnfants" placeholder="Nombre d'enfants">
<input id="cvPoste" placeholder="Dernier poste">
<input id="cvLoisirs" placeholder="Loisirs">
<input id="cvCaractere" placeholder="Caract√®re">
<input id="cvDiplome" placeholder="Dernier dipl√¥me">
<input id="cvEtablissement" placeholder="√âtablissement">
<input id="cvAlcool" placeholder="Alcoolique Oui/Non">
<input id="cvSalaire" placeholder="Salaire">
<input id="cvEmail" placeholder="Email">
<input id="cvTelMtn" placeholder="Tel MTN">
<input id="cvTelOrange" placeholder="Tel Orange">
<canvas id="cvCanvas" class="signature-canvas"></canvas>
<div class="flex-row">
<button class="primary" onclick="openPaymentPopup('cvDoc','pdf')">üìÑ T√©l√©charger PDF</button>
<button class="primary" onclick="openPaymentPopup('cvDoc','word')">üíæ T√©l√©charger Word</button>
</div>
</section>

<!-- Lettre -->
<section id="lettreDoc">
<h2>‚úâÔ∏è Lettre de Motivation</h2>
<input id="lettrePrenom" placeholder="Pr√©nom">
<input id="lettreNom" placeholder="Nom">
<input id="lettreEntreprise" placeholder="Entreprise">
<input id="lettrePoste" placeholder="Poste souhait√©">
<textarea id="lettreContenu" placeholder="Contenu de la lettre"></textarea>
<canvas id="lettreCanvas" class="signature-canvas"></canvas>
<div class="flex-row">
<button class="primary" onclick="openPaymentPopup('lettreDoc','pdf')">üìÑ T√©l√©charger PDF</button>
<button class="primary" onclick="openPaymentPopup('lettreDoc','word')">üíæ T√©l√©charger Word</button>
</div>
</section>

<!-- Plan -->
<section id="planDoc">
<h2>üó∫Ô∏è Plan de Localisation</h2>
<textarea id="planContenu" placeholder="Saisir le plan de localisation"></textarea>
<canvas id="planCanvas" class="signature-canvas"></canvas>
<div class="flex-row">
<button class="primary" onclick="openPaymentPopup('planDoc','pdf')">üìÑ T√©l√©charger PDF</button>
<button class="primary" onclick="openPaymentPopup('planDoc','word')">üíæ T√©l√©charger Word</button>
</div>
</section>

<!-- Popup paiement -->
<div id="popupOverlay">
<div id="popup">
<h2>Paiement requis</h2>
<p>B√©n√©ficiaire: Wirnkar Loveline</p>
<p>Num√©ros: MTN 676353859 / Orange 640647072</p>
<p>Montant unitaire: 100 FCFA / heure</p>
<div class="flex-row">
<label>Multiplier: <span id="multiplierDisplay">1</span></label>
<button onclick="incrementMultiplier()">+</button>
<button onclick="decrementMultiplier()">-</button>
</div>
<p>Total: <span id="totalAmount">100</span> FCFA</p>
<textarea id="momoMsg" placeholder="Message Mobile Money"></textarea>
<input id="transactionId" placeholder="ID de transaction">
<input id="adminCode" type="password" placeholder="Code admin">
<div id="popupResult"></div>
<p>Temps restant: <span id="remainingTime">0 min</span></p>
<div class="flex-row">
<button class="primary" onclick="validatePayment()">‚úÖ Valider</button>
<button onclick="closePopup()">Annuler</button>
</div>
</div>
</div>

<script>
// ===== CONFIG =====
const ADMIN_CODE='xz233233';
const UNIT_PRICE=100;
const UNIT_HOURS=1;
const PAYMENT_BENEF='Wirnkar Loveline';

// ===== Canvas signature =====
function initSignatureCanvas(id){
  const c=document.getElementById(id);
  if(!c) return;
  c.width=c.offsetWidth; c.height=c.offsetHeight;
  const ctx=c.getContext('2d'); ctx.lineWidth=2; ctx.lineCap='round';
  let draw=false;
  function pos(e){const r=c.getBoundingClientRect(); if(e.touches&&e.touches.length)return{x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top}; return{x:e.clientX-r.left,y:e.clientY-r.top};}
  c.addEventListener('mousedown',e=>{draw=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y);});
  c.addEventListener('mousemove',e=>{if(!draw)return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(p.x,p.y);});
  c.addEventListener('mouseup',()=>{draw=false; ctx.beginPath();});
  c.addEventListener('mouseleave',()=>{draw=false; ctx.beginPath();});
  c.addEventListener('touchstart',e=>{draw=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault();},{passive:false});
  c.addEventListener('touchmove',e=>{if(!draw)return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault();},{passive:false});
  c.addEventListener('touchend',()=>{draw=false; ctx.beginPath();});
}
['cvCanvas','lettreCanvas','planCanvas'].forEach(initSignatureCanvas);

// ===== Photo CV =====
const cvPhotoInput=document.getElementById('cvPhotoInput');
const cvPhotoPreview=document.getElementById('cvPhotoPreview');
cvPhotoInput.addEventListener('change',e=>{const f=e.target.files?.[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{cvPhotoPreview.style.backgroundImage=`url(${ev.target.result})`; cvPhotoPreview.textContent='';}; r.readAsDataURL(f);});

// ===== Popup paiement =====
let multiplier=1,currentDocId='',currentAction='';
function incrementMultiplier(){multiplier++; updatePopup();}
function decrementMultiplier(){if(multiplier>1){multiplier--; updatePopup();}}
function updatePopup(){document.getElementById('multiplierDisplay').innerText=multiplier; document.getElementById('totalAmount').innerText=multiplier*UNIT_PRICE;}
function resetMultiplier(){multiplier=1; updatePopup();}
function openPaymentPopup(docId,action){currentDocId=docId; currentAction=action; resetMultiplier(); document.getElementById('momoMsg').value=''; document.getElementById('transactionId').value=''; document.getElementById('adminCode').value=''; document.getElementById('popupResult').innerHTML=''; document.getElementById('popupOverlay').style.display='flex';}
function closePopup(){document.getElementById('popupOverlay').style.display='none'; resetMultiplier();}

// ===== Validation paiement =====
function validatePayment(){
  const admin=document.getElementById('adminCode').value.trim();
  if(admin===ADMIN_CODE){document.getElementById('popupResult').innerHTML='<span style="color:green">Code admin accept√© ‚úÖ</span>'; setTimeout(proceedAction,500); return;}
  const msg=document.getElementById('momoMsg').value.trim();
  const tx=document.getElementById('transactionId').value.trim();
  if(!msg||!tx){document.getElementById('popupResult').innerHTML='<span style="color:red">Message Mobile Money et ID requis.</span>'; return;}
  if(!msg.toLowerCase().includes(PAYMENT_BENEF.toLowerCase())){document.getElementById('popupResult').innerHTML='<span style="color:red">B√©n√©ficiaire incorrect.</span>'; return;}
  const expected=UNIT_PRICE*multiplier; const match=msg.match(/(\d{2,})/);
  if(!match||parseInt(match[1],10)!==expected){document.getElementById('popupResult').innerHTML=`<span style="color:red">Montant attendu ${expected} FCFA.</span>`; return;}
  const now=Date.now(); const expiry=parseInt(localStorage.getItem('abonnementExpiry')||'0',10);
  localStorage.setItem('abonnementExpiry',String(Math.max(now,expiry)+multiplier*UNIT_HOURS*3600*1000));
  document.getElementById('popupResult').innerHTML='<span style="color:green">Paiement valid√© ‚úÖ</span>';
  setTimeout(proceedAction,500);
}

// ===== Actions apr√®s paiement =====
function proceedAction(){
  closePopup(); if(!currentDocId||!currentAction) return;
  const section=document.getElementById(currentDocId);
  // remplacer canvas par image pour Word
  const canvases=section.querySelectorAll('canvas.signature-canvas');
  canvases.forEach(c=>{const img=document.createElement('img'); img.src=c.toDataURL(); img.style.width='100%'; img.style.height='auto'; c.parentNode.replaceChild(img,c);});
  html2canvas(section).then(canvas=>{
    const imgData=canvas.toDataURL('image/png');
    if(currentAction==='pdf'){
      const { jsPDF }=window.jspdf; const pdf=new jsPDF('p','mm','a4'); const imgProps=pdf.getImageProperties(imgData);
      const pdfWidth=pdf.internal.pageSize.getWidth();
      const pdfHeight=(imgProps.height*pdfWidth)/imgProps.width;
      pdf.addImage(imgData,'PNG',0,0,pdfWidth,pdfHeight);
      pdf.save('document.pdf');
    } else if(currentAction==='word'){
      let htmlContent=section.innerHTML;
      const blob=new Blob(['<html><body>'+htmlContent+'</body></html>'],{type:'application/msword'});
      saveAs(blob,'document.doc');
    }
  });
}
</script>
</body>
</html>