<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Documents A5 Stables</title>
<style>
body{font-family:"Segoe UI",Arial,sans-serif;background:#e0f7fa;margin:0;padding:12px;}
h1{text-align:center;color:#00695c;margin:6px 0 16px;font-size:24px;}
section{background:#fff;border-radius:10px;padding:12px;margin:10px auto;max-width:780px;box-shadow:0 6px 18px rgba(0,0,0,0.08);}
h2{margin:0 0 12px;font-size:18px;color:#333;}
.photo{width:120px;height:120px;border-radius:8px;border:2px dashed #ff6f00;background-position:center;background-size:cover;display:flex;align-items:center;justify-content:center;color:#ff6f00;font-weight:700;cursor:pointer;object-fit:cover;}
.signature{height:28px;border-radius:6px;border:1px solid #43a047;width:100%;margin-top:8px;}
.actions{display:flex;gap:8px;margin-top:8px;}
.btn{background:#00c853;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:600;font-size:12px;}
.btn.secondary{background:#2196f3;}
#popupOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;}
#popup{width:100%;max-width:420px;background:#fff;border-radius:10px;padding:12px;border:3px solid #1e88e5;box-sizing:border-box;}
label{font-size:13px;display:block;margin-top:6px;}
.muted{color:#666;font-size:13px;}
.text-area{resize:none;width:100%;padding:10px;font-size:14px;border:none;border-radius:6px;box-sizing:border-box;overflow:auto;min-height:100px;}
.text-img{float:left;width:100px;height:100px;margin-right:8px;margin-bottom:8px;object-fit:cover;border:1px solid #aaa;border-radius:4px;}
</style>
</head>
<body>
<h1>üìÑ Mes Documents A5</h1>

<!-- CV -->
<section id="cvDoc">
<h2>Curriculum Vitae</h2>
<div style="display:flex; gap:12px; align-items:flex-start;">
  <div style="flex:0 0 120px;">
    <img id="cvPhoto" class="photo" src="" alt="Photo">
    <input type="file" id="cvPhotoInput" accept="image/*" style="display:none">
  </div>
  <div style="flex:1;">
    <div contenteditable="true" id="cvNomPrenom" style="font-weight:700;font-size:22px;">Nom Pr√©nom</div>
    <div contenteditable="true" id="cvFonctionAge" style="font-size:14px;margin-top:4px;">Fonction - √Çge</div>
    <div id="cvInfos" style="margin-top:12px;">
      <div contenteditable="true">Situation matrimoniale: </div>
      <div contenteditable="true">Nombre d'enfants: </div>
      <div contenteditable="true">R√©gion: </div>
      <div contenteditable="true">Nationalit√©: </div>
      <div contenteditable="true">Ville de r√©sidence: </div>
      <div contenteditable="true">Quartier: </div>
      <div contenteditable="true">Alcoolique (oui/non): </div>
      <div contenteditable="true">Religion: </div>
      <div contenteditable="true">Autres exp√©riences: </div>
      <div contenteditable="true">Dernier dipl√¥me: </div>
      <div contenteditable="true">Dernier √©tablissement: </div>
      <div contenteditable="true">Dernier poste occup√©: </div>
      <div contenteditable="true">Dernier salaire: </div>
    </div>
    <label class="muted">Signature</label>
    <canvas id="cvSign" class="signature"></canvas>
    <div class="actions">
      <button class="btn" onclick="openPayment('cvDoc','pdf')">PDF</button>
      <button class="btn" onclick="openPayment('cvDoc','word')">Word</button>
    </div>
  </div>
</div>
</section>

<!-- Lettre de Motivation -->
<section id="lettreDoc">
<h2>Lettre de Motivation</h2>
<div style="position:relative;">
  <input type="file" id="lettrePhotoInput" accept="image/*" style="display:none">
  <img id="lettrePhoto" class="text-img" src="" alt="Photo">
  <div id="lettreTexte" contenteditable="true" class="text-area" style="height:400px;" placeholder="Tapez votre lettre ici..."></div>
</div>
<label class="muted">Signature</label>
<canvas id="lettreSign" class="signature"></canvas>
<div class="actions">
  <button class="btn" onclick="openPayment('lettreDoc','pdf')">PDF</button>
  <button class="btn" onclick="openPayment('lettreDoc','word')">Word</button>
</div>
</section>

<!-- Plan de Localisation -->
<section id="planDoc">
<h2>Plan de Localisation</h2>
<div style="position:relative;">
  <input type="file" id="planPhotoInput" accept="image/*" style="display:none">
  <img id="planPhoto" class="text-img" src="" alt="Photo">
  <div id="planTexte" contenteditable="true" class="text-area" style="height:400px;" placeholder="D√©crivez le plan ici..."></div>
</div>
<label class="muted">Signature</label>
<canvas id="planSign" class="signature"></canvas>
<div class="actions">
  <button class="btn" onclick="openPayment('planDoc','pdf')">PDF</button>
  <button class="btn" onclick="openPayment('planDoc','word')">Word</button>
</div>
</section>

<!-- Popup Paiement -->
<div id="popupOverlay">
<div id="popup">
<h3>Paiement requis</h3>
<p class="muted">B√©n√©ficiaire: <strong>Wirnkar Loveline</strong></p>
<p class="muted">Num√©ros: MTN 676353859 / Orange 640647072</p>
<p class="muted">Prix unitaire: <strong>100 FCFA / unit√©</strong></p>
<div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
<button onclick="multPlus()" class="btn secondary">+</button>
<div class="muted">Quantit√©: <span id="mult">1</span></div>
<button onclick="multMinus()" class="btn secondary">-</button>
<div style="margin-left:auto;" class="muted">Total: <strong><span id="total">100</span> FCFA</strong></div>
</div>
<label>Message Mobile Money</label>
<textarea id="momo" placeholder="Ex : Wirnkar Loveline 100 2025-09-27T12:00"></textarea>
<label>ID Transaction</label>
<input id="tx" type="text" placeholder="ID transaction">
<label>Code admin (optionnel)</label>
<input id="admin" type="password" placeholder="Code admin">
<div class="actions" style="margin-top:10px;">
<button class="btn" onclick="validatePay()">Valider</button>
<button class="btn secondary" onclick="closePopup()">Annuler</button>
</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// Photos CV/Lettre/Plan
function handlePhoto(imgId,inputId){
  const el=document.getElementById(imgId);
  const input=document.getElementById(inputId);
  el.addEventListener('click',()=>input.click());
  input.addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=ev=>{el.src=ev.target.result;};
    reader.readAsDataURL(f);
  });
}
handlePhoto('cvPhoto','cvPhotoInput');
handlePhoto('lettrePhoto','lettrePhotoInput');
handlePhoto('planPhoto','planPhotoInput');

// Canevas signature
function makeSign(id){
  const c=document.getElementById(id);
  if(!c)return;
  c.width=c.clientWidth*devicePixelRatio;
  c.height=c.clientHeight*devicePixelRatio;
  const ctx=c.getContext('2d'); ctx.scale(devicePixelRatio,devicePixelRatio);
  ctx.lineJoin='round'; ctx.lineCap='round'; ctx.strokeStyle='#222'; ctx.lineWidth=2;
  let drawing=false;
  function pos(e){const r=c.getBoundingClientRect(); if(e.touches && e.touches[0]) return{x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top}; return{x:e.clientX-r.left,y:e.clientY-r.top};}
  function start(e){drawing=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault&&e.preventDefault();}
  function move(e){if(!drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke();}
  function end(){drawing=false; ctx.closePath();}
  c.addEventListener('mousedown',start); c.addEventListener('mousemove',move);
  c.addEventListener('mouseup',end); c.addEventListener('mouseleave',end);
  c.addEventListener('touchstart',start,{passive:false}); c.addEventListener('touchmove',move,{passive:false}); c.addEventListener('touchend',end);
}
makeSign('cvSign'); makeSign('lettreSign'); makeSign('planSign');

// Popup paiement
let multiplier=1,UNIT=100,BENEF='Wirnkar Loveline',ADMIN='xz233233';
let usedTransactions = []; // Stocke IDs et heure

function multPlus(){multiplier++;document.getElementById('mult').innerText=multiplier;document.getElementById('total').innerText=UNIT*multiplier;}
function multMinus(){if(multiplier>1) multiplier--;document.getElementById('mult').innerText=multiplier;document.getElementById('total').innerText=UNIT*multiplier;}
function openPayment(id,act){window.__doc=id;window.__act=act;document.getElementById('popupOverlay').style.display='flex';}
function closePopup(){document.getElementById('popupOverlay').style.display='none';}

function validatePay(){
  const admin=document.getElementById('admin').value.trim();
  const msg=document.getElementById('momo').value.trim();
  const tx=document.getElementById('tx').value.trim();
  const now = new Date();

  if(admin===ADMIN){
    exportDoc();
    closePopup();
    return;
  }

  if(!msg || !tx){
    alert("Message et ID requis");
    return;
  }

  if(!msg.toLowerCase().includes(BENEF.toLowerCase())){
    alert("Nom b√©n√©ficiaire incorrect");
    return;
  }

  const amt=parseInt(msg.match(/\d+/)?.[0],10);
  if(amt !== UNIT*multiplier){
    alert("Montant incorrect");
    return;
  }

  if(usedTransactions.some(t => t.id === tx)){
    alert("Cette transaction a d√©j√† √©t√© utilis√©e !");
    return;
  }

  const timeMatch = msg.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/);
  if(timeMatch){
    const msgTime = new Date(timeMatch[0]);
    const diffMinutes = Math.abs(now - msgTime)/60000;
    if(diffMinutes > 10){
      alert("L'heure de la transaction est incorrecte (>10 min de diff√©rence)");
      return;
    }
  }

  // Tout correct
  usedTransactions.push({id: tx, time: now});
  exportDoc();
  closePopup();
}

// Export PDF/Word
async function exportDoc(){
  const id=window.__doc,act=window.__act; if(!id) return; 
  const node=document.getElementById(id); if(!node) return;

  let format = (id==='lettreDoc' || id==='planDoc') ? 'a6' : 'a5';
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm',format);
  const pageW = pdf.internal.pageSize.getWidth(),
        pageH = pdf.internal.pageSize.getHeight();

  const clone = node.cloneNode(true);
  clone.style.width = pageW + "mm";
  clone.style.fontSize = "10px";
  clone.style.lineHeight = "1.2";
  clone.style.padding = "4px";
  clone.style.position = "fixed";
  clone.style.left = "-9999px";
  document.body.appendChild(clone);

  const canvas = await html2canvas(clone,{scale:2,useCORS:true});
  document.body.removeChild(clone);

  const imgData = canvas.toDataURL("image/png");
  const imgW = pageW, 
        imgH = (canvas.height * imgW) / canvas.width;

  pdf.addImage(imgData,'PNG',0,0,imgW,imgH);

  if(act==='pdf'){ 
    pdf.save(id + '.pdf'); 
    return; 
  }

  const blob=new Blob(
    ['<html><body>'+node.innerHTML+'</body></html>'],
    {type:'application/msword'}
  );
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=id+'.doc';
  a.click();
}
</script>
</body>
</html>