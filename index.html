<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CV / Lettre - Partage WhatsApp avec Paiement</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#25D366" />
<style>
  :root{--green:#25D366;--bg:#f0f8ff;--card:#fff;--blue:#1e90ff;}
  body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:12px;background:var(--bg);-webkit-font-smoothing:antialiased;}
  h1{margin:8px 0 12px}
  section{background:var(--card);padding:10px;border-radius:10px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
  input, textarea, button, select {width:100%;box-sizing:border-box;padding:10px;margin:6px 0;border:1px solid var(--blue);border-radius:8px;font-size:14px;background:#fff;}
  textarea{min-height:100px;resize:vertical;overflow:auto}
  button.primary{background:var(--green);color:#fff;border:none;font-weight:700;cursor:pointer}
  button.ghost{background:#fff;color:var(--blue);border:2px solid var(--blue);cursor:pointer}
  /* popup */
  #popupOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;padding:20px;z-index:9999}
  #popup{max-width:420px;width:100%;background:#fff;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,0.3)}
  #popup h2{margin:0 0 8px;font-size:18px}
  .row{display:flex;gap:8px}
  .small{font-size:13px;color:#555}
  .muted{font-size:13px;color:#666;margin-bottom:8px}
  .badge{display:inline-block;padding:6px 8px;border-radius:8px;background:#f6f6f6;font-weight:700;color:#333;margin-right:6px}
  .error{color:#b00020;background:#ffe6e6;padding:8px;border-radius:8px;margin-top:8px}
  .success{color:#006400;background:#e6ffe6;padding:8px;border-radius:8px;margin-top:8px}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .helper{font-size:12px;color:#666;margin-top:6px}
</style>
</head>
<body>

<h1>üìÑ CV / Lettre de Motivation</h1>

<!-- === FORM (inchang√©) === -->
<section>
  <h2>Nom et Profession</h2>
  <input type="text" id="fullName" placeholder="Nom complet">
  <input type="text" id="profession" placeholder="Profession / poste">
</section>

<section>
  <h2>Informations CV</h2>
  <input type="text" id="prenom" placeholder="Pr√©nom">
  <input type="number" id="age" placeholder="√Çge">
  <input type="text" id="ville" placeholder="Ville">
  <input type="text" id="quartier" placeholder="Quartier">
  <input type="text" id="situation" placeholder="Situation matrimoniale">
  <input type="number" id="enfants" placeholder="Nombre d'enfants">
  <input type="text" id="poste" placeholder="Dernier poste occup√©">
  <input type="text" id="loisirs" placeholder="Loisirs">
  <input type="text" id="caractere" placeholder="Caract√®re">
  <input type="text" id="diplome" placeholder="Dernier dipl√¥me">
  <input type="text" id="etablissement" placeholder="Dernier √©tablissement">
  <input type="text" id="alcool" placeholder="Alcoolique Oui/Non">
  <input type="number" id="salaire" placeholder="Salaire">
  <input type="email" id="email" placeholder="Email">
  <input type="tel" id="telMtn" placeholder="Num√©ro MTN">
  <input type="tel" id="telOrange" placeholder="Num√©ro Orange/Camtel">
</section>

<section>
  <h2>Lettre de Motivation ‚úâÔ∏è</h2>
  <input type="text" id="prenomLetter" placeholder="Pr√©nom">
  <input type="text" id="nomLetter" placeholder="Nom">
  <input type="text" id="entreprise" placeholder="Entreprise">
  <input type="text" id="posteLetter" placeholder="Poste souhait√©">
  <textarea id="contenu" placeholder="Contenu de la lettre"></textarea>
</section>

<section>
  <h2>Plan de localisation üó∫Ô∏è</h2>
  <textarea id="plan" placeholder="R√©digez votre plan de localisation ici"></textarea>
</section>

<!-- Share button triggers popup -->
<div class="flex-between" style="gap:8px">
  <button id="shareTrigger" class="primary">üì§ Partager sur WhatsApp</button>
  <button id="saveBtn" class="ghost" onclick="saveLocal()">üíæ Sauvegarder local</button>
</div>

<p class="helper">Si le paiement n'est pas v√©rifi√©, le partage est refus√©. L'utilisateur peut reprendre et corriger les erreurs.</p>

<!-- ===== Popup Payment ===== -->
<div id="popupOverlay">
  <div id="popup" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
    <div class="flex-between">
      <h2 id="popupTitle">Paiement requis avant partage</h2>
      <button onclick="closePopup()" class="ghost" style="padding:6px 10px">Annuler</button>
    </div>

    <p class="muted">Veuillez envoyer le paiement Mobile Money au b√©n√©ficiaire ci‚Äëdessous, puis copiez/collez le message de confirmation dans le champ ¬´ Message Mobile Money ¬ª. Saisissez aussi le code administrateur.</p>

    <div style="margin-bottom:8px">
      <div class="badge">B√©n√©ficiaire</div><span style="font-weight:700">Wirnkar Loveline</span><br>
      <div style="margin-top:6px">
        <span class="small">MTN MoMo :</span> <strong>676353859</strong><br>
        <span class="small">Orange Money :</span> <strong>640647072</strong><br>
        <span class="small">Montant :</span> <strong>25 FCFA</strong>
      </div>
    </div>

    <label class="small">Collez ici le message de confirmation Mobile Money (texte complet)</label>
    <textarea id="momoMessage" placeholder="Ex: Transfert de 30 FCFA effectue ... 2025-09-26 00:10:39 ... transaction Id: 14101710093"></textarea>

    <label class="small">Code administrateur</label>
    <input id="adminCode" placeholder="Code admin (ex: 233233n)" type="password">

    <div id="verifyResult" style="min-height:26px;"></div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="verifyBtn" class="primary">‚úÖ V√©rifier et Partager</button>
      <button onclick="closePopup()" class="ghost">‚ùå Annuler</button>
    </div>

    <p class="helper" style="margin-top:10px">Remarque : la v√©rification compare le nom, le num√©ro, le montant et la date/heure (d√©lai maximal 5 minutes).</p>
  </div>
</div>

<script>
/* ====== Configuration attendue (changeable) ====== */
const EXPECTED = {
  nameTokens: ['wirnkar','loveline'], // tokens to check in beneficiary name
  momoNumbers: ['676353859','237676353859'], // MoMo numbers (local + with country)
  omNumbers: ['640647072'], // Orange Money
  amountFCFA: 25,
  adminCode: '233233n', // as specified by user; change to '233233' if needed
  maxDelayMinutes: 5
};

/* Helper: open/close popup */
function showPopup(){ document.getElementById('popupOverlay').style.display='flex'; document.getElementById('verifyResult').innerHTML=''; }
function closePopup(){ document.getElementById('popupOverlay').style.display='none'; }

/* Save local (simple) */
function saveLocal(){
  const data = {};
  document.querySelectorAll('input,textarea').forEach(el=>{
    if(el.id) data[el.id] = el.value;
  });
  localStorage.setItem('cvData', JSON.stringify(data));
  alert('Donn√©es sauvegard√©es localement.');
}

/* Attach share button */
document.getElementById('shareTrigger').addEventListener('click', ()=>{
  // show popup instead of immediate share
  showPopup();
});

/* Verify & Share */
document.getElementById('verifyBtn').addEventListener('click', ()=>{
  const rawMsg = (document.getElementById('momoMessage').value || '').trim();
  const admin = (document.getElementById('adminCode').value || '').trim();

  const resultBox = document.getElementById('verifyResult');
  resultBox.innerHTML = ''; resultBox.className='';

  // Basic admin code check
  if(admin !== EXPECTED.adminCode){
    resultBox.innerHTML = '<div class="error">Code administrateur incorrect.</div>';
    return;
  }

  if(!rawMsg){
    resultBox.innerHTML = '<div class="error">Veuillez coller le message Mobile Money re√ßu.</div>';
    return;
  }

  // Parse message: try to extract amount, name, phone, timestamp
  const lower = rawMsg.toLowerCase();

  // 1) amount (digits) e.g. "30 FCFA" or "30 fcfa" or "30.0"
  const amtMatch = rawMsg.match(/(\d+(?:[.,]\d+)?)\s*(fcf?a?|cfa|xfaf?)/i) || rawMsg.match(/amount[:\s]*([0-9]+)\b/i);
  const amount = amtMatch ? parseFloat( (amtMatch[1]||amtMatch[0]).toString().replace(',', '.') ) : null;

  // 2) phone: find sequences of 8-12 digits
  const phoneMatch = rawMsg.match(/(\b\d{8,13}\b)/g) || [];
  // sanitize phones: remove leading + if any
  const phones = phoneMatch.map(s => s.replace(/^\+/, ''));

  // 3) timestamp: look for yyyy-mm-dd hh:mm:ss or dd/mm/yyyy hh:mm:ss variants
  let timeStamp = null;
  const isoMatch = rawMsg.match(/(\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2})/);
  if(isoMatch){ timeStamp = isoMatch[1]; }
  else {
    const altMatch = rawMsg.match(/(\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}:\d{2})/);
    if(altMatch) {
      // convert dd/mm/yyyy hh:mm:ss to yyyy-mm-dd hh:mm:ss
      const parts = altMatch[1].split(' ');
      const dparts = parts[0].split('/');
      timeStamp = `${dparts[2]}-${dparts[1]}-${dparts[0]} ${parts[1]}`;
    } else {
      // small chance: yyyy/mm/dd
      const iso2 = rawMsg.match(/(\d{4}\/\d{2}\/\d{2}\s+\d{2}:\d{2}:\d{2})/);
      if(iso2) timeStamp = iso2[1].replace(/\//g,'-');
    }
  }

  // 4) name: try to detect beneficiary name tokens
  const hasNameTokens = EXPECTED.nameTokens.every(tok => lower.includes(tok.toLowerCase()));

  // 5) phone matching expected numbers
  const normalizedPhones = phones.map(p => p.replace(/^0+|^\+|^237/, '') ); // strip leading zeros, +, country code 237
  // normalized expected numbers (strip country code)
  function norm(p){ return p.replace(/^0+|^\+|^237/, ''); }
  const expectedPhones = [...EXPECTED.momoNumbers, ...EXPECTED.omNumbers].map(norm);
  const phoneMatchesExpected = normalizedPhones.some(p => expectedPhones.includes(p));

  // 6) amount matching
  const amountMatchOk = (amount !== null) && (Math.round(amount) === EXPECTED.amountFCFA);

  // 7) timestamp check within window
  let timeOk = false;
  let parsedDate = null;
  if(timeStamp){
    // parse as local time or attempt Date parse
    // Accept formats "YYYY-MM-DD HH:MM:SS"
    const iso = timeStamp.replace(' ', 'T');
    parsedDate = new Date(iso);
    if(isNaN(parsedDate.getTime())){
      // fallback: try Date.parse raw
      parsedDate = new Date(timeStamp);
    }
    if(!isNaN(parsedDate.getTime())){
      const now = new Date();
      const diffMs = Math.abs(now - parsedDate);
      const diffMin = diffMs / 1000 / 60;
      timeOk = diffMin <= EXPECTED.maxDelayMinutes;
    }
  }

  // Build detailed feedback
  const feedback = [];
  if(!hasNameTokens) feedback.push('‚úñ Le nom du b√©n√©ficiaire ne correspond pas.');
  if(!phoneMatchesExpected) feedback.push('‚úñ Le num√©ro d√©tect√© ne correspond pas aux num√©ros attendus.');
  if(!amountMatchOk) feedback.push(`‚úñ Montant incorrect (attendu ${EXPECTED.amountFCFA} FCFA). D√©tect√©: ${amount!==null?amount+' FCFA':'non trouv√©'}.`);
  if(!timeStamp) feedback.push('‚úñ Date/heure introuvable dans le message. (format attendu: YYYY-MM-DD HH:MM:SS)');
  else if(!timeOk) feedback.push('‚úñ La date/heure du message est trop ancienne (> '+EXPECTED.maxDelayMinutes+' minutes).');
  // admin already checked earlier

  if(feedback.length){
    resultBox.innerHTML = '<div class="error">' + feedback.join('<br>') + '</div>';
    return;
  }

  // All checks passed: share on WhatsApp
  resultBox.innerHTML = '<div class="success">‚úÖ V√©rification OK ‚Äî partage en cours...</div>';

  // prepare the WhatsApp message (use the CV form content)
  const fullName = getValue('fullName');
  const profession = getValue('profession');
  const prenom = getValue('prenom');
  const age = getValue('age');
  const ville = getValue('ville');
  const quartier = getValue('quartier');
  const situation = getValue('situation');
  const enfants = getValue('enfants');
  const poste = getValue('poste');
  const loisirs = getValue('loisirs');
  const caractere = getValue('caractere');
  const diplome = getValue('diplome');
  const etablissement = getValue('etablissement');
  const alcool = getValue('alcool');
  const salaire = getValue('salaire');
  const email = getValue('email');
  const telMtn = getValue('telMtn');
  const telOrange = getValue('telOrange');

  const prenomLetter = getValue('prenomLetter');
  const nomLetter = getValue('nomLetter');
  const entreprise = getValue('entreprise');
  const posteLetter = getValue('posteLetter');
  const contenu = getValue('contenu');
  const plan = getValue('plan');

  const messageToShare = `üìÑ *${fullName}* (_${profession}_)

*Pr√©nom:* ${prenom}
*√Çge:* ${age}
*Ville:* ${ville}
*Quartier:* ${quartier}
*Situation:* ${situation}
*Enfants:* ${enfants}
*Dernier poste:* ${poste}
*Loisirs:* ${loisirs}
*Caract√®re:* ${caractere}
*Dipl√¥me:* ${diplome}
*√âtablissement:* ${etablissement}
*Alcoolique:* ${alcool}
*Salaire:* ${salaire}
*Email:* ${email}
*Tel MTN:* ${telMtn}
*Tel Orange:* ${telOrange}

‚úâÔ∏è *Lettre de Motivation*
*Pr√©nom:* ${prenomLetter}
*Nom:* ${nomLetter}
*Entreprise:* ${entreprise}
*Poste souhait√©:* ${posteLetter}
*Contenu:*
${contenu}

üó∫Ô∏è *Plan de localisation*
${plan}

‚úÖ Paiement confirm√© via message : "${rawMsg}"`;

  // open WhatsApp share
  const url = `https://wa.me/?text=${encodeURIComponent(messageToShare)}`;
  // small delay so user sees the success message
  setTimeout(()=> {
    window.open(url, '_blank');
  }, 700);
});

/* Utility: get form values by id */
function getValue(id){ return document.getElementById(id)?.value || ""; }

/* Onload: try to restore saved data */
window.addEventListener('load', ()=>{
  try{
    const saved = JSON.parse(localStorage.getItem('cvData') || '{}');
    Object.keys(saved).forEach(k => {
      const el = document.getElementById(k);
      if(el) el.value = saved[k];
    });
  }catch(e){/* ignore */ }
});
</script>

</body>
</html>