<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Messenger en ligne</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
header { display: flex; justify-content: space-between; align-items: center; background:#333; color:white; padding:5px 10px; flex-wrap: wrap; }
.menu-container { display: flex; gap:10px; overflow-x:auto; }
.menu { position: relative; }
.menu button { background:#444; color:white; border:none; padding:6px 10px; cursor:pointer; border-radius:5px; white-space:nowrap; }
.menu-content { display:none; position:absolute; background:#f9f9f9; min-width:200px; max-height:200px; overflow-y:auto; overflow-x:hidden; border:1px solid #ccc; z-index:10; }
.menu-content a { display:block; padding:6px; color:black; text-decoration:none; white-space:nowrap; }
.menu-content a:hover { background:#eee; }
.menu:hover .menu-content { display:block; }

#worldClock { display:flex; align-items:center; gap:5px; }
select { padding:3px; }

.annonces { display:flex; flex-direction:column; margin-top:5px; }
.annonce { background:#ff9800; color:white; padding:6px; overflow:hidden; white-space:nowrap; }
.annonce:nth-child(2) { background:#2196F3; margin-top:2px; }
.annonce span { display:inline-block; padding-left:100%; animation: scroll 15s linear infinite; }
@keyframes scroll { 0% { transform:translateX(0); } 100% { transform:translateX(-100%); } }

main { padding:10px; }
#groupList .group { padding:6px; border:1px solid #ccc; margin-top:5px; border-radius:5px; cursor:pointer; display:flex; justify-content:space-between; }
#groupList .group:hover { background:#f2f2f2; }
#chatBox { border:1px solid #ccc; padding:8px; height:250px; overflow-y:auto; margin-top:10px; }
.message { padding:4px; border-bottom:1px solid #eee; position:relative; word-break:break-word; }
.message .actions { font-size:11px; position:absolute; bottom:2px; right:2px; }
.message .actions button { margin-left:3px; }

footer { background:#333; color:white; text-align:center; padding:6px; margin-top:10px; font-size:12px; }

#adminPanel { display:none; padding:10px; background:#f4f4f4; border-top:2px solid #333; font-size:14px; }
#adminPanel h2,h3 { margin:5px 0; }
#adminPanel textarea, #adminPanel input { width:100%; margin-bottom:6px; padding:6px; font-size:14px; }
#adminPanel button { padding:5px 10px; margin-right:5px; font-size:14px; }
</style>
</head>
<body>

<header>
  <div class="menu-container">
    <div class="menu">
      <button>üìÇ Groupes & Priv√©</button>
      <div class="menu-content" id="menuGroups"></div>
    </div>
    <div class="menu">
      <button>üîó Liens</button>
      <div class="menu-content" id="menuLinks"></div>
    </div>
  </div>
  <div id="worldClock">
    <select id="countrySelect">
      <option value="Africa/Dakar">S√©n√©gal</option>
      <option value="Africa/Douala">Cameroun</option>
      <option value="Europe/Paris">France</option>
      <option value="America/New_York">New York</option>
      <option value="Asia/Tokyo">Tokyo</option>
    </select>
    <span id="currentTime"></span>
  </div>
</header>

<div class="annonces">
  <div class="annonce"><span id="annonce1">Annonce 1 d√©file ici...</span></div>
  <div class="annonce"><span id="annonce2">Annonce 2 d√©file ici...</span></div>
</div>

<main>
  <h2>Cr√©er un Groupe</h2>
  <input type="text" id="groupName" placeholder="Nom du groupe">
  <button onclick="createGroup()">Cr√©er</button>

  <h2>Rechercher un Groupe</h2>
  <input type="text" id="searchInput" placeholder="Rechercher..." onkeyup="searchGroups()">

  <div id="groupList"></div>

  <h2 id="chatTitle">Chat</h2>
  <div id="chatBox"></div>
  <input type="text" id="messageInput" placeholder="√âcrire un message...">
  <input type="file" id="mediaInput" multiple>
  <button onclick="sendMessage()">Envoyer</button>
</main>

<div id="adminPanel">
  <h2>Panneau Administrateur</h2>
  <h3>Annonces</h3>
  <textarea id="adminAnnonce1" placeholder="Texte annonce 1"></textarea>
  <textarea id="adminAnnonce2" placeholder="Texte annonce 2"></textarea>
  <button onclick="updateAnnonces()">Mettre √† jour</button>

  <h3>Liens</h3>
  <input type="text" id="newLink" placeholder="Nouveau lien">
  <button onclick="addLink()">Ajouter</button>
  <ul id="linkList"></ul>

  <h3>Blocage utilisateurs</h3>
  <input type="text" id="blockUserId" placeholder="ID utilisateur">
  <button onclick="blockUser()">Bloquer</button>
  <button onclick="unblockUser()">D√©bloquer</button>
</div>

<footer>
  Mini Messenger ¬© 2025 - Supabase
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://chgyzvowfsblodxbagfa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoZ3l6dm93ZnNibG9keGJhZ2ZhIiwicm9sZSI6ImF0IjoxNzU3NzYwNjI0LCJleHAiOjIwNzMzMzY2MjR9.JEg_WFTJlB3gNBI8-oaP35N68tu9p6TGl6vM3sYPL4Y";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let userId = "user_" + Math.floor(Math.random()*100000);
let groups = [], links = ["https://google.com","https://vercel.com"], blockedUsers = [];
let currentChat = null;

let adminCode = prompt("Entrez le code admin (laisser vide si non admin):");
if(adminCode==="233233") document.getElementById("adminPanel").style.display="block";

function updateClock(){
  const tz = document.getElementById("countrySelect").value;
  document.getElementById("currentTime").innerText = new Date().toLocaleString("fr-FR",{timeZone: tz});
}
setInterval(updateClock,1000); updateClock();

async function fetchGroups(){
  const { data, error } = await supabase.from("groups").select("*");
  if(!error) { groups = data; renderGroups(groups); renderMenuGroups(); }
}
fetchGroups();

async function createGroup(){
  let name = document.getElementById("groupName").value.trim();
  if(!name) return alert("Nom invalide !");
  const { data, error } = await supabase.from("groups").insert([{name, members:[userId], messages:[]}]);
  if(!error) { document.getElementById("groupName").value=""; fetchGroups(); }
}

function searchGroups(){ 
  let input = document.getElementById("searchInput").value.toLowerCase();
  renderGroups(groups.filter(g=>g.name.toLowerCase().includes(input)));
}

function renderGroups(list){
  let container = document.getElementById("groupList"); container.innerHTML="";
  list.forEach(g=>{
    let div = document.createElement("div"); div.className="group";
    div.innerHTML=`<span>${g.name} (${g.members.length} membres)</span>`;
    div.onclick=()=>joinChat(g); container.appendChild(div);
  });
}

function renderMenuGroups(){
  let menu = document.getElementById("menuGroups"); menu.innerHTML="";
  groups.forEach(g=>{
    let a = document.createElement("a"); a.href="#"; a.innerText=g.name+" ("+g.members.length+")";
    a.onclick=()=>joinChat(g); menu.appendChild(a);
  });
}

function renderMenuLinks(){
  let menu=document.getElementById("menuLinks"); menu.innerHTML="";
  links.forEach(l=>{
    let a=document.createElement("a"); a.href=l; a.target="_blank"; a.innerText=l;
    menu.appendChild(a);
  });
}

function addLink(){ let val=document.getElementById("newLink").value.trim(); if(!val) return; links.push(val); renderMenuLinks(); document.getElementById("newLink").value=""; }
function updateAnnonces(){ document.getElementById("annonce1").innerText=document.getElementById("adminAnnonce1").value || "Annonce 1"; document.getElementById("annonce2").innerText=document.getElementById("adminAnnonce2").value || "Annonce 2"; }
function blockUser(){ let uid=document.getElementById("blockUserId").value.trim(); if(!uid) return; if(!blockedUsers.includes(uid)) blockedUsers.push(uid); document.getElementById("blockUserId").value=""; alert("Utilisateur bloqu√© : "+uid);}
function unblockUser(){ let uid=document.getElementById("blockUserId").value.trim(); blockedUsers=blockedUsers.filter(u=>u!==uid); document.getElementById("blockUserId").value=""; alert("Utilisateur d√©bloqu√© : "+uid); }

function joinChat(chat){ currentChat = chat; if(!chat.members.includes(userId)) chat.members.push(userId); document.getElementById("chatTitle").innerText=chat.name+" ("+chat.members.length+" membres)"; renderChat(); }

functionrenderChat = async () => {
  if(!currentChat) return;
  const { data, error } = await supabase.from("groups").select("*").eq("id", currentChat.id).single();
  if(!error) currentChat = data;

  const chatBox = document.getElementById("chatBox");
  chatBox.innerHTML = "";
  if(currentChat.messages) {
    const now = Date.now();
    currentChat.messages = currentChat.messages.filter(m => now - m.timestamp < 24*60*60*1000);
    currentChat.messages.forEach((m,index) => {
      const div = document.createElement("div");
      div.className = "message";
      let mediaHtml = "";
      if(m.media){
        if(m.media.type.startsWith("image")) mediaHtml=`<img src="${m.media.url}" style="max-width:100%">`;
        else if(m.media.type.startsWith("video")) mediaHtml=`<video src="${m.media.url}" controls style="max-width:100%"></video>`;
        else if(m.media.type.startsWith("audio")) mediaHtml=`<audio controls src="${m.media.url}"></audio>`;
        else mediaHtml=`<a href="${m.media.url}" target="_blank">Fichier</a>`;
      }
      div.innerHTML=`<strong>${m.user}</strong>: ${m.text||""} ${mediaHtml}`;
      
      const actions=document.createElement("div"); actions.className="actions";
      const likeBtn=document.createElement("button"); likeBtn.innerText="‚ù§ "+(m.likes||0);
      likeBtn.onclick=async ()=>{
        m.likes=(m.likes||0)+1;
        await supabase.from("groups").update({messages: currentChat.messages}).eq("id",currentChat.id);
        renderChat();
      };
      actions.appendChild(likeBtn);

      if(m.user===userId || adminCode==="233233"){
        const editBtn=document.createElement("button"); editBtn.innerText="‚úèÔ∏è";
        editBtn.onclick=async ()=>{
          const newText=prompt("Modifier message:", m.text);
          if(newText!==null){ m.text=newText; await supabase.from("groups").update({messages: currentChat.messages}).eq("id",currentChat.id); renderChat(); }
        };
        const delBtn=document.createElement("button"); delBtn.innerText="üóëÔ∏è";
        delBtn.onclick=async ()=>{
          currentChat.messages.splice(index,1);
          await supabase.from("groups").update({messages: currentChat.messages}).eq("id",currentChat.id);
          renderChat();
        };
        actions.appendChild(editBtn); actions.appendChild(delBtn);
      }

      div.appendChild(actions);
      chatBox.appendChild(div);
    });
  }
  chatBox.scrollTop=chatBox.scrollHeight;
};

document.getElementById("messageInput").addEventListener("keypress", async (e)=>{
  if(e.key==="Enter") await sendMessage();
});

async function sendMessage(){
  if(!currentChat) return;
  const text=document.getElementById("messageInput").value.trim();
  const files=document.getElementById("mediaInput").files;
  if(!text && files.length===0) return;
  const newMsg = {id:Date.now(), user:userId, text, media:null, likes:0, timestamp:Date.now()};
  if(files.length>0){
    newMsg.media=[];
    for(let f of files){
      const reader = new FileReader();
      await new Promise(resolve=>{
        reader.onload=e=>{
          newMsg.media.push({url:e.target.result, type:f.type});
          resolve();
        };
        reader.readAsDataURL(f);
      });
    }
  }
  if(!currentChat.messages) currentChat.messages=[];
  currentChat.messages.push(newMsg);
  await supabase.from("groups").update({messages: currentChat.messages}).eq("id",currentChat.id);
  document.getElementById("messageInput").value="";
  document.getElementById("mediaInput").value="";
  renderChat();
}

// Rafra√Æchissement automatique toutes les 10 secondes
setInterval(()=>{ if(currentChat) renderChat(); fetchGroups(); }, 10000);
</script>
</body>
</html>