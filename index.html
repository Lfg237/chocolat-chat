<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mini Secr√©tariat Complet - Signatures</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet"/>
<style>
:root{--bg1:#ffefd5;--bg2:#ffe4f0;--accent:#ff6b6b;}
*{box-sizing:border-box;}
body{margin:0;font-family:Inter,sans-serif;background:linear-gradient(120deg,var(--bg1),var(--bg2));color:#222;}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:rgba(255,255,255,0.6);backdrop-filter:blur(6px);box-shadow:0 6px 18px rgba(0,0,0,0.06);}
.brand{display:flex;align-items:center;gap:12px;}
.brand .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(45deg,#ff9a9e,#fad0c4);display:flex;align-items:center;justify-content:center;font-size:28px;}
.brand h1{font-family:Dancing Script,cursive;margin:0;font-size:20px;color:var(--accent);}
.navbar{overflow:auto;white-space:nowrap;padding:10px;}
.navbar button{display:inline-block;margin-right:8px;padding:10px 14px;border-radius:999px;border:0;background:linear-gradient(90deg,#fff,rgba(255,255,255,0.6));box-shadow:0 4px 8px rgba(0,0,0,0.06);cursor:pointer;}
.container{padding:18px;display:grid;grid-template-columns:1fr;gap:18px;}
.main{background:rgba(255,255,255,0.85);padding:14px;border-radius:14px;min-height:80vh;}
.doc-title{font-family:Dancing Script,cursive;font-size:22px;margin:6px 0;}
.handwritten{font-family:'Dancing Script',cursive;font-weight:700;font-size:28px;color:#2c3e50;}
.doc-photo{
  width:120px;
  height:120px;
  object-fit:cover;
  border-radius:10px;
  border:3px solid white;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
  float:left; 
  margin-right:12px;
  margin-bottom:12px;
  cursor:pointer;
}
.signature-area{border:1px dashed #ccc;padding:6px;border-radius:8px;display:block;margin-bottom:6px;}
.field{margin-bottom:8px;}
.field label{display:block;font-size:13px;color:#555;margin-bottom:4px;}
.field input[type=text], .field input[type=email], .field input[type=tel], .field textarea{
  width:100%;
  padding:6px;
  border-radius:6px;
  border:1px solid #eee;
}
textarea{
  resize:none;
  min-height:60px;
  overflow-y:hidden;
}
.btn{padding:10px 14px;border-radius:8px;border:0;cursor:pointer;margin-top:4px;}
.btn-primary{background:linear-gradient(90deg,#4facfe,#00f2fe);color:white;}
.btn-ghost{background:transparent;border:1px solid #ddd;margin-left:6px;}
#paymentModal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:1000;}
#paymentModal > div{background:white;border-radius:12px;padding:18px;max-width:680px;width:100%;}
#pmMsg{margin-top:8px;color:crimson;}
</style>
</head>
<body>

<header class="header">
  <div class="brand">
    <div class="logo">LF</div>
    <h1>Mini Secr√©tariat ‚Äî LesFacilitateurs</h1>
  </div>
  <div class="small">‚ú® Moderne ‚Ä¢ Color√© ‚Ä¢ Export PDF/Image</div>
</header>

<nav class="navbar" id="mainNav"></nav>

<div class="container">
  <main class="main" id="app">
    <p>Bienvenue dans le Mini Secr√©tariat. Choisissez un document pour commencer ‚ú®</p>
  </main>

  <footer class="footer">¬© LesFacilitateurs ‚Äî Mini Secr√©tariat</footer>

  <div id="paymentModal">
    <div>
      <h3>Paiement requis avant t√©l√©chargement</h3>
      <div>
        <h4>Mobile Money / OM</h4>
        <input id="mmBen1" type="text" value="loveline wirnkar momo: 676353859" readonly/>
        <input id="mmBen2" type="text" value="OM 640647072" readonly style="margin-top:4px"/>
        <label>Message de transaction</label>
        <input id="mmMsg" type="text" placeholder="Ex: Vous avez recu ..."/>
      </div>
      <div style="margin-top:8px">
        <h4>Acc√®s VIP</h4>
        <input id="vipInput" type="text" placeholder="Entrez votre code VIP"/>
      </div>
      <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="validatePayment()">Valider paiement / VIP</button>
      <button class="btn btn-ghost" onclick="closePaymentModal()">Annuler</button>
      <p id="pmMsg"></p>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// --- Variables ---
const documents = ['CV','CarteVisite','LettreMotivation','Plan','Fiche','Galerie','Protocole','Contrat','Facture','Devis'];
const nav = document.getElementById('mainNav');
let pendingDoc = null;
let mmHistory = [];
const VIP_CODE = '233233';

// --- Cr√©er boutons ---
documents.forEach(doc=>{
  const btn = document.createElement('button');
  btn.textContent = doc.replace(/([A-Z])/g," $1").trim();
  btn.onclick = ()=>openDoc(doc);
  nav.appendChild(btn);
});

// --- Ouvrir document ---
function openDoc(doc){
  pendingDoc=doc;
  const app=document.getElementById('app');
  app.innerHTML=`<h2 class="doc-title handwritten">${doc.replace(/([A-Z])/g," $1").trim()}</h2>` + generateDocHTML(doc);
  initSignatures();
}

// --- G√©n√©rer HTML pour documents ---
function generateDocHTML(doc){
  const sigId = 'sig'+doc;
  const sigCanvas = `<canvas id="${sigId}" class="signature-area" width="300" height="80"></canvas>
                     <button class="btn btn-ghost" onclick="clearCanvas('${sigId}')">üóë Effacer signature</button>`;

  return `
<div style="display:flex;align-items:center;gap:12px;">
  <input type="file" id="photo${doc}" accept="image/*" style="display:none" onchange="displayPhoto('photo${doc}','img${doc}')"/>
  <label for="photo${doc}">
    <img id="img${doc}" class="doc-photo" title="Cliquez pour importer la photo"/>
  </label>
</div>
<div class="field"><label>Texte</label><textarea rows="3"></textarea></div>
${sigCanvas}
<button class="btn btn-primary" onclick="requestPayment()">T√©l√©charger PDF</button>`;
}

// --- Importer photo depuis le t√©l√©phone ---
function displayPhoto(inputId, imgId){
  const file = document.getElementById(inputId).files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = e => document.getElementById(imgId).src = e.target.result;
    reader.readAsDataURL(file);
  }
}

// --- Effacer canvas ---
function clearCanvas(id){
  const canvas=document.getElementById(id);
  if(canvas){const ctx=canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);}
}

// --- Initialiser signatures ---
function initSignatures() {
  document.querySelectorAll('canvas.signature-area').forEach(c => {
    const ctx = c.getContext('2d');
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    let drawing = false;

    // Fonction pour obtenir les coordonn√©es selon l'appareil (souris ou doigt)
    function getPos(e) {
      const rect = c.getBoundingClientRect();
      if (e.touches && e.touches[0]) {
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      } else {
        return {
          x: e.offsetX ?? e.clientX - rect.left,
          y: e.offsetY ?? e.clientY - rect.top
        };
      }
    }

    // D√©marrer le dessin
    function startDraw(e) {
      e.preventDefault();
      drawing = true;
      const pos = getPos(e);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    }

    // Continuer √† dessiner
    function draw(e) {
      if (!drawing) return;
      e.preventDefault();
      const pos = getPos(e);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
    }

    // Arr√™ter le dessin
    function stopDraw(e) {
      if (!drawing) return;
      e.preventDefault();
      drawing = false;
    }

    // Support universel : souris + tactile
    c.addEventListener('mousedown', startDraw);
    c.addEventListener('mousemove', draw);
    c.addEventListener('mouseup', stopDraw);
    c.addEventListener('mouseleave', stopDraw);

    c.addEventListener('touchstart', startDraw);
    c.addEventListener('touchmove', draw);
    c.addEventListener('touchend', stopDraw);
  });
}



// --- Paiement ---
function requestPayment(){document.getElementById('paymentModal').style.display='flex';}
function closePaymentModal(){document.getElementById('paymentModal').style.display='none';}

// --- Validation paiement / VIP ---
function validatePayment(){
  const msg = document.getElementById('mmMsg').value.trim();
  const vip = document.getElementById('vipInput').value.trim();
  let valid=false;

  if(vip === VIP_CODE) valid = true;

  if(msg){
    const re = /MICHEL KONO\s*(\w*)\s*ÓÄÅ(\d+)\s*.*?Id:\s*(\d+).*?(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/i;
    const m = msg.match(re);
    if(m){
      const [_,name,number,id,dt] = m;
      const dateTx = new Date(dt);
      const now = new Date();
      const diffMin = (now - dateTx)/60000;
      if(!mmHistory.includes(id) && diffMin <= 10){
        mmHistory.push(id);
        valid = true;
      } else {
        document.getElementById('pmMsg').innerText = "Transaction invalide ou doublon/d√©lai d√©pass√©.";
        return;
      }
    } else {
      document.getElementById('pmMsg').innerText = "Format message incorrect.";
      return;
    }
  }

  if(valid){
    document.getElementById('pmMsg').innerText = "Paiement / VIP valid√© !";
    closePaymentModal();
    downloadPDF();
  } else {
    document.getElementById('pmMsg').innerText = "Paiement non valid√©.";
  }
}

// --- T√©l√©charger PDF ---
function downloadPDF() {
  if (!pendingDoc) return;
  const app = document.getElementById('app');

  // 1Ô∏è‚É£ Sauvegarder les canvases sous forme d'image avant la capture
  const canvases = app.querySelectorAll('canvas.signature-area');
  const tempImages = [];
  canvases.forEach(c => {
    const img = document.createElement('img');
    img.src = c.toDataURL('image/png');
    img.style.width = c.style.width || c.width + 'px';
    img.style.height = c.style.height || c.height + 'px';
    img.style.border = c.style.border;
    img.className = c.className;
    c.replaceWith(img);
    tempImages.push({ canvas: c, image: img });
  });

  // 2Ô∏è‚É£ Capturer le contenu
  html2canvas(app, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

    // Ajouter les textes des textarea
    const textareas = app.querySelectorAll('textarea');
    pdf.setFontSize(12);
    let y = 10;
    textareas.forEach(ta => {
      const lines = pdf.splitTextToSize(ta.value, pdfWidth - 20);
      pdf.text(10, y, lines);
      y += lines.length * 6 + 5;
    });

    // 3Ô∏è‚É£ Restaurer les canvases (pour ne pas perdre les signatures dans la page)
    tempImages.forEach(({ canvas, image }) => image.replaceWith(canvas));

    pdf.save(`${pendingDoc}.pdf`);
  });
}

// --- Contenu par d√©faut pour les documents ---
function generateDocHTML(doc){
  const sigId = 'sig'+doc;
  const sigCanvas = `<canvas id="${sigId}" class="signature-area" width="300" height="80"></canvas>
                     <button class="btn btn-ghost" onclick="clearCanvas('${sigId}')">üóë Effacer signature</button>`;
  
  let content = '';
  switch(doc){
    case 'CV':
      content = `<div class="field"><label>Nom complet</label><textarea rows="2">John Doe</textarea></div>
                 <div class="field"><label>Exp√©rience</label><textarea rows="3">D√©veloppeur Web depuis 5 ans...</textarea></div>`;
      break;
    case 'LettreMotivation':
      content = `<div class="field"><label>Objet</label><textarea rows="2">Candidature pour le poste...</textarea></div>
                 <div class="field"><label>Texte</label><textarea rows="4">Je souhaite postuler car...</textarea></div>`;
      break;
    case 'CarteVisite':
      content = `<div class="field"><label>Nom</label><textarea rows="1">John Doe</textarea></div>
                 <div class="field"><label>Email</label><textarea rows="1">john@example.com</textarea></div>
                 <div class="field"><label>T√©l√©phone</label><textarea rows="1">+237 6XXXXXXX</textarea></div>`;
      break;
    default:
      content = `<div class="field"><label>Texte</label><textarea rows="3">Votre contenu ici...</textarea></div>`;
  }

  return `
<div style="display:flex;align-items:center;gap:12px;">
  <input type="file" id="photo${doc}" accept="image/*" style="display:none" onchange="displayPhoto('photo${doc}','img${doc}')"/>
  <label for="photo${doc}">
    <img id="img${doc}" class="doc-photo" title="Cliquez pour importer la photo"/>
  </label>
</div>
${content}
${sigCanvas}
<button class="btn btn-primary" onclick="requestPayment()">T√©l√©charger PDF</button>`;
}

</script>
</body>
</html>