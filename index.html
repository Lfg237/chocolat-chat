<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mini Secrétariat Complet</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet"/>
<style>
:root{--bg1:#ffefd5;--bg2:#ffe4f0;--accent:#ff6b6b;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Inter,sans-serif;background:linear-gradient(120deg,var(--bg1),var(--bg2));color:#222;overflow-x:hidden;}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:rgba(255,255,255,0.6);backdrop-filter:blur(6px);box-shadow:0 6px 18px rgba(0,0,0,0.06);position:sticky;top:0;z-index:10;}
.brand{display:flex;align-items:center;gap:12px;}
.brand .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(45deg,#ff9a9e,#fad0c4);display:flex;align-items:center;justify-content:center;font-size:28px;}
.brand h1{font-family:Dancing Script,cursive;margin:0;font-size:20px;color:var(--accent);}
.navbar{overflow-x:auto;white-space:nowrap;padding:10px;background:rgba(255,255,255,0.6);backdrop-filter:blur(6px);}
.navbar button{display:inline-block;margin-right:8px;padding:10px 14px;border-radius:999px;border:0;background:linear-gradient(90deg,#fff,rgba(255,255,255,0.6));box-shadow:0 4px 8px rgba(0,0,0,0.06);cursor:pointer;font-size:11px;}
.container{padding:8px;display:flex;justify-content:center;flex-direction:column;align-items:center;}
.main{background:rgba(255,255,255,0.9);padding:8mm;border-radius:12px;width:95%;max-width:600px;min-height:105mm;overflow-y:auto;-webkit-overflow-scrolling:touch;position:relative;font-size:12px;line-height:1.4;word-wrap: break-word;}
.doc-title{font-family:Dancing Script,cursive;font-size:18px;margin:6px 0;}
.handwritten{font-family:'Dancing Script',cursive;font-weight:700;font-size:16px;color:#2c3e50;}
.doc-photo{width:60px;height:60px;object-fit:cover;border-radius:50%;border:2px solid white;box-shadow:0 4px 12px rgba(0,0,0,0.08);cursor:pointer;margin-bottom:8px;}
.field{margin-bottom:12px;}
.field label{display:block;font-size:11px;color:#555;margin-bottom:4px;font-weight:600;}
.field textarea{width:100%;min-height:150px;max-height:400px;padding:8px;border:1px solid #eee;border-radius:6px;font-size:12px;line-height:1.4;resize:vertical;overflow-y:auto;background-color:#fff8dc;}
.btn{padding:6px 10px;border-radius:8px;border:0;cursor:pointer;margin-top:4px;font-size:12px;}
.btn-primary{background:linear-gradient(90deg,#4facfe,#00f2fe);color:white;}
.btn-ghost{background:transparent;border:1px solid #ddd;margin-left:6px;font-size:12px;}
#previewContainer{width:95%;max-width:600px;margin-top:12px;}
.preview-doc{border:1px solid #ccc;padding:10px;margin-bottom:12px;border-radius:8px;background:#fffbe6;}
.preview-doc img{width:60px;height:60px;border-radius:50%;margin-right:4px;float:left;}
#paymentModal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:1000;}
#paymentModal > div{background:white;border-radius:12px;padding:18px;max-width:400px;width:100%;}
#pmMsg{margin-top:8px;color:crimson;}
.signature-pad{border:1px solid #ccc;border-radius:8px;width:100%;height:100px;background:#fff;}
</style>
</head>
<body>

<header class="header">
  <div class="brand">
    <div class="logo">LF</div>
    <h1>Mini Secrétariat</h1>
  </div>
  <div class="small">✨ Tous les documents • Photos flottantes • Fiche 70 noms éditable • Paiement strict</div>
</header>

<nav class="navbar" id="mainNav"></nav>

<div class="container">
  <main class="main" id="app">
    <p>Bienvenue dans le Mini Secrétariat. Choisissez un document pour commencer ✨</p>
  </main>
  <button class="btn btn-primary" onclick="genererApercu()">Voir tous les documents</button>
  <button class="btn btn-primary" onclick="ouvrirPopup()">Exporter PDF</button>
  <div id="previewContainer"></div>
</div>

<!-- Popup paiement -->
<div id="paymentModal">
  <div>
    <h3>Paiement requis</h3>
    <div><strong>Bénéficiaire :</strong> LOVELINE WIRNKAR</div>
    <div><strong>OM :</strong> 640647072</div>
    <div><strong>MOMO :</strong> 676353859</div>
    <div style="margin-top:8px">
      <label>Message Mobile Money</label>
      <input id="mmMsg" type="text" placeholder="Copiez le message reçu" style="font-size:13px"/>
    </div>
    <div style="margin-top:8px">
      <label>Code Admin / VIP</label>
      <input id="vipInput" type="text" placeholder="Entrez votre code" style="font-size:13px"/>
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="verifierPaiementStrict()">Valider</button>
    <button class="btn btn-ghost" onclick="fermerPopup()">Annuler</button>
    <p id="pmMsg"></p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.4/dist/signature_pad.umd.min.js"></script>
<script>
// ================== CONFIG ==================
const documents=['CV','CarteVisite','LettreMotivation','CNI','ProtocoleAccord','ContratTravail','PlanLocalisation','Fiche70Noms','Rapport','GaleriePhotos'];
const VIP_CODE = '233233';
const BENEFICIAIRE = 'Loveline Wirnkar';
const NUM_OM = '640647072';
const NUM_MOMO = '676353859';
const nav=document.getElementById('mainNav');
const noms = Array.from({length:70},(_,i)=>'Nom '+(i+1));
let currentPage = 0;
const nomsPerPage = 14;

// ================== NAV ==================
documents.forEach(doc=>{
  const btn=document.createElement('button');
  btn.textContent=doc.replace(/([A-Z])/g," $1").trim();
  btn.onclick=()=>{ doc==='Fiche70Noms' ? ouvrirFiche() : ouvrirDoc(doc); };
  nav.appendChild(btn);
});

// ================== DOCUMENTS ==================
function ouvrirDoc(doc){
  const app=document.getElementById('app');
  const photoHTML=(id,title)=>`
    <input type="file" id="${id}" accept="image/*" style="display:none" onchange="afficherPhoto('${id}','img${id}')"/>
    <label for="${id}"><img id="img${id}" class="doc-photo" title="${title}"/></label>`;
  
  let content='';
  switch(doc){
    case 'CNI':
      content=`${photoHTML('CNIrecto','CNI Recto')}<textarea>Texte recto...</textarea>
               ${photoHTML('CNIverso','CNI Verso')}<textarea>Texte verso...</textarea>`; break;
    case 'GaleriePhotos':
      content=`<div id="galleryContainer"></div>
               <button class="btn btn-ghost" onclick="ajouterPhotoGalerie()">➕ Ajouter photo</button>`; break;
    default:
      content=`${photoHTML(doc+'Photo',doc)}<textarea>Votre contenu...</textarea>`;
  }

  content+=`<canvas id="signaturePad" class="signature-pad"></canvas>
            <button class="btn btn-ghost" onclick="clearSignature()">Effacer signature</button>
            <button class="btn btn-ghost" onclick="app.innerHTML='<p>Bienvenue dans le Mini Secrétariat...</p>'">Retour</button>`;

  app.innerHTML=`<h2 class="doc-title handwritten">${doc.replace(/([A-Z])/g," $1").trim()}</h2>`+content;

  const canvas=document.getElementById('signaturePad');
  window.signaturePad=new SignaturePad(canvas);

  document.querySelectorAll('textarea').forEach(t=>{
    t.addEventListener('input',()=>{ t.style.height='auto'; t.style.height=t.scrollHeight+'px'; });
  });
}

// ================== PHOTOS ==================
function afficherPhoto(inputId,imgId){
  const input=document.getElementById(inputId);
  const img=document.getElementById(imgId);
  if(input.files && input.files[0]){
    const reader=new FileReader();
    reader.onload=e=>{document.getElementById(imgId).src=e.target.result;};
    reader.readAsDataURL(input.files[0]);
  }
}
function ajouterPhotoGalerie(){
  const container=document.getElementById('galleryContainer');
  const index=container.children.length+1;
  const id='galleryPhoto'+index;
  const html=`<div style="display:flex; flex-direction:column; margin-bottom:8px;">
                <input type="file" id="${id}" accept="image/*" style="display:none" onchange="afficherPhoto('${id}','img${id}')"/>
                <label for="${id}"><img id="img${id}" class="doc-photo"/></label>
                <textarea>Commentaire...</textarea>
              </div>`;
  container.insertAdjacentHTML('beforeend',html);
}

// ================== SIGNATURE ==================
function clearSignature(){ window.signaturePad.clear(); }

// ================== FICHE 70 NOMS ==================
function ouvrirFiche(){
  const app=document.getElementById('app');
  app.innerHTML = `
    <h2 class="doc-title handwritten">Fiche 70 Noms</h2>
    <div id="ficheContainer" style="display:flex;gap:12px;"></div>
    <div style="margin-top:8px;">
      <button class="btn btn-ghost" onclick="prevPage()">⬅ Page précédente</button>
      <button class="btn btn-ghost" onclick="nextPage()">Page suivante ➡</button>
      <button class="btn btn-ghost" onclick="ajouterNomFiche()">➕ Ajouter Nom</button>
      <button class="btn btn-ghost" onclick="app.innerHTML='<p>Bienvenue dans le Mini Secrétariat...</p>'">Retour</button>
    </div>
    <canvas id="signaturePad" class="signature-pad"></canvas>
    <button class="btn btn-ghost" onclick="clearSignature()">Effacer signature</button>
  `;
  afficherPage(currentPage);
  const canvas=document.getElementById('signaturePad');
  window.signaturePad=new SignaturePad(canvas);
}

function afficherPage(page){
  const container=document.getElementById('ficheContainer');
  container.innerHTML='';
  const start = page * nomsPerPage;
  const end = Math.min(start + nomsPerPage, noms.length);
  const pageNoms = noms.slice(start, end);

  const col1=document.createElement('div');
  const col2=document.createElement('div');
  col1.style.flex='1'; col2.style.flex='1';
  col1.style.display='flex'; col1.style.flexDirection='column'; col1.style.gap='4px';
  col2.style.display='flex'; col2.style.flexDirection='column'; col2.style.gap='4px';

  pageNoms.forEach((nom,i)=>{
    const input=document.createElement('input');
    input.value=nom;
    input.style.fontSize='12px'; input.style.padding='4px'; input.style.border='1px solid #ddd'; input.style.borderRadius='4px';
    input.oninput = e => { noms[start+i] = e.target.value; };
    (i < Math.ceil(pageNoms.length/2) ? col1 : col2).appendChild(input);
  });

  container.appendChild(col1);
  container.appendChild(col2);
}

function nextPage(){ if((currentPage+1)*nomsPerPage<noms.length){ currentPage++; afficherPage(currentPage); } }
function prevPage(){ if(currentPage>0){ currentPage--; afficherPage(currentPage); } }
function ajouterNomFiche(){ noms.push('Nouveau Nom'); afficherPage(currentPage); }

// ================== PAIEMENT ==================
let countdownInterval;
function ouvrirPopup(){
  document.getElementById('paymentModal').style.display='flex';
  document.getElementById('pmMsg').textContent='';
  document.getElementById('mmMsg').value='';
  document.getElementById('vipInput').value='';
  startCountdown(10); // 10 min
}
function fermerPopup(){
  document.getElementById('paymentModal').style.display='none';
  clearInterval(countdownInterval);
  document.getElementById('pmMsg').textContent='';
}
function startCountdown(minutes){
  let remaining = minutes*60;
  const pmMsg = document.getElementById('pmMsg');
  countdownInterval = setInterval(()=>{
    const min = Math.floor(remaining/60);
    const sec = remaining % 60;
    pmMsg.style.color='blue';
    pmMsg.textContent=`Temps restant pour validation : ${min}m ${sec}s`;
    remaining--;
    if(remaining<0){
      clearInterval(countdownInterval);
      pmMsg.style.color='crimson';
      pmMsg.textContent='Le message est expiré ⏰';
    }
  },1000);
}

function verifierPaiementStrict(){
  const msg=document.getElementById('mmMsg').value.trim();
  const vip=document.getElementById('vipInput').value.trim();
  const pmMsg=document.getElementById('pmMsg');

  // VIP
  if(vip===VIP_CODE){
    clearInterval(countdownInterval);
    pmMsg.style.color='green';
    pmMsg.textContent='Accès VIP valide ✔';
    setTimeout(()=>{ fermerPopup(); exporterPDF(); }, 500);
    return}

  if(!msg){
    pmMsg.style.color='crimson';
    pmMsg.textContent='Veuillez coller le message reçu.';
    return;
  }

  const msgLower = msg.toLowerCase();
  const nomOK = msgLower.includes(BENEFICIAIRE.toLowerCase());
  const omOK = msg.includes(NUM_OM);
  const momoOK = msg.includes(NUM_MOMO);

  // Vérification stricte : nom + OM ou MOMO + temps < 10 min
  if(nomOK && (omOK || momoOK)){
    clearInterval(countdownInterval);
    pmMsg.style.color='green';
    pmMsg.textContent='Paiement Mobile Money validé ✔';
    setTimeout(()=>{
      fermerPopup();
      exporterPDF();
    },500);
  } else {
    pmMsg.style.color='crimson';
    pmMsg.textContent='Le message ne correspond pas au bénéficiaire ou aux numéros.';
  }
}

// ================== EXPORT PDF ==================
function exporterPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'mm', format:'a4'});
  const content = document.getElementById('app');

  // Ajouter le texte principal
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(12);

  const lines = content.innerText.split('\n');
  let y = 20;
  lines.forEach(line=>{
    doc.text(line, 20, y);
    y += 6;
  });

  // Ajouter les images flottantes
  const imgs = content.querySelectorAll('img');
  let x = 20, imgY = y;
  imgs.forEach(img=>{
    if(img.src){
      doc.addImage(img.src, 'JPEG', x, imgY, 30, 30);
      x += 35;
      if(x>150){ x=20; imgY +=35; }
    }
  });

  // Ajouter la signature si présente
  if(window.signaturePad && !window.signaturePad.isEmpty()){
    const sigData = window.signaturePad.toDataURL('image/png');
    doc.addImage(sigData, 'PNG', 20, imgY+10, 60, 30);
  }

  doc.save('Document_Mini_Secrétariat.pdf');
}

// ================== APERCU ==================
function genererApercu(){
  const container = document.getElementById('previewContainer');
  container.innerHTML='';
  documents.forEach(doc=>{
    const div = document.createElement('div');
    div.className='preview-doc';
    div.textContent=doc.replace(/([A-Z])/g," $1").trim();
    container.appendChild(div);
  });
}
</script>

</body>
</html>